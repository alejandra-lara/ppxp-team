---
- name: uaa_database_name
  type: string
  configurable: false
  default: uaa

- name: uaa_database
  type: selector
  configurable: true
  default: internal_mysql
  option_templates:
    - name: internal_mysql
      select_value: internal_mysql
      named_manifests:
      - name: db_config
        manifest: |
          (( .properties.system_database.selected_option.parsed_manifest(uaadb) ))
      - name: ca_certs
        manifest: |
          (( .properties.system_database.selected_option.parsed_manifest(uaadb_certs) ))

    - name: external
      select_value: external
      property_blueprints:
        - name: host
          type: string
          configurable: true
        - name: port
          type: port
          configurable: true
        - name: uaa_username
          type: string
          configurable: true
        - name: uaa_password
          type: secret
          configurable: true
        - name: ca_cert
          type: text
          configurable: true
          optional: true
      named_manifests:
      - name: db_config
        manifest: |
          db_scheme: mysql
          tls: '(( .properties.uaa_database.external.ca_cert.value ? "enabled_skip_hostname_validation" : "disabled" ))'
          tls_protocols: TLSv1.2
          address: (( .properties.uaa_database.external.host.value ))
          port: (( .properties.uaa_database.external.port.value ))
          roles:
          - tag: admin
            name: (( .properties.uaa_database.external.uaa_username.value ))
            password: (( .properties.uaa_database.external.uaa_password.value ))
          databases:
          - tag: uaa
            name: (( .properties.uaa_database_name.value ))
      - name: ca_certs
        manifest: |
          - (( $ops_manager.ca_certificate ))
          - '(( .properties.uaa_database.external.ca_cert.value ? .properties.uaa_database.external.ca_cert.value : "" ))'
