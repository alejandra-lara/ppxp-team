---
property_blueprints:
  - name: app_usage_service_database
    type: string
    configurable: false
    default: app_usage_service

  - name: autoscale_database
    type: string
    configurable: false
    default: autoscale

  - name: ccdb_database
    type: string
    configurable: false
    default: ccdb

  - name: notifications_database
    type: string
    configurable: false
    default: notifications

  - name: uaa_database
    type: string
    configurable: false
    default: uaa

  - name: console_database
    type: string
    configurable: false
    default: console

  - name: system_database
    type: selector
    configurable: true
    default: internal_mysql
    option_templates:
      - name: internal
        select_value: internal
        named_manifests:
          - name: ccdb
            manifest: |
              address: (( .ccdb.first_ip ))
              port: 2544
              db_scheme: "postgres"
              roles:
              - tag: admin
                name: (( .ccdb.credentials.identity ))
                password: (( .ccdb.credentials.password ))
              databases:
              - tag: cc
                name: ccdb
                citext: true
          - name: uaadb
            manifest: |
              address: (( .uaadb.first_ip ))
              port: 2544
              db_scheme: postgresql
              roles:
              - tag: admin
                name: (( .uaadb.credentials.identity ))
                password: (( .uaadb.credentials.password ))
              databases:
              - tag: uaa
                name: uaa
          - name: notifications
            manifest: |
              url: mysql://(( .mysql.notifications_credentials.identity )):(( .mysql.notifications_credentials.password ))@mysql.service.cf.internal:3306/notifications
              max_open_connections: 10
          - name: autoscaling
            manifest: |
              url: mysql://(( .mysql.autoscale_credentials.identity )):(( .mysql.autoscale_credentials.password ))@mysql.service.cf.internal:3306/autoscale
          - name: console
            manifest: |
              ip: (( .consoledb.first_ip ))
              username: (( .consoledb.credentials.identity ))
              password: (( .consoledb.credentials.password ))
              adapter: postgres
          - name: push-app-usage-service
            manifest: |
              name: app_usage_service
              port: 3306
              ip: mysql.service.cf.internal
              username: (( .mysql.app_usage_credentials.identity ))
              password: (( .mysql.app_usage_credentials.password ))
          - name: diegodb
            manifest: |
              db_connection_string: (( .mysql.diegodb_credentials.identity )):(( .mysql.diegodb_credentials.password ))@tcp(mysql.service.cf.internal:3306)/diego
              max_open_connections: 100
          - name: routingdb
            manifest: |
              type: "mysql"
              schema: routing
              host: mysql.service.cf.internal
              port: 3306
              username: (( .mysql.routingdb_credentials.identity ))
              password: (( .mysql.routingdb_credentials.password ))

      - name: internal_mysql
        select_value: internal_mysql
        named_manifests:
        - name: ccdb
          manifest: |
            address: mysql.service.cf.internal
            port: 3306
            db_scheme: mysql
            roles:
            - tag: admin
              name: (( .mysql.ccdb_credentials.identity ))
              password: (( .mysql.ccdb_credentials.password ))
            databases:
            - tag: cc
              name: ccdb
              citext: true
        - name: uaadb
          manifest: |
            address: mysql.service.cf.internal
            port: 3306
            db_scheme: mysql
            roles:
            - tag: admin
              name: (( .mysql.uaadb_credentials.identity ))
              password: (( .mysql.uaadb_credentials.password ))
            databases:
            - tag: uaa
              name: uaa
        - name: notifications
          manifest: |
            url: mysql://(( .mysql.notifications_credentials.identity )):(( .mysql.notifications_credentials.password ))@mysql.service.cf.internal:3306/notifications
            max_open_connections: 10
        - name: autoscaling
          manifest: |
            url: mysql://(( .mysql.autoscale_credentials.identity )):(( .mysql.autoscale_credentials.password ))@mysql.service.cf.internal:3306/autoscale
        - name: console
          manifest: |
            ip: mysql.service.cf.internal
            port: 3306
            username: (( .mysql.consoledb_credentials.identity ))
            password: (( .mysql.consoledb_credentials.password ))
            adapter: mysql
        - name: push-app-usage-service
          manifest: |
            name: app_usage_service
            port: 3306
            ip: mysql.service.cf.internal
            username: (( .mysql.app_usage_credentials.identity ))
            password: (( .mysql.app_usage_credentials.password ))
        - name: diegodb
          manifest: |
            db_connection_string: (( .mysql.diegodb_credentials.identity )):(( .mysql.diegodb_credentials.password ))@tcp(mysql.service.cf.internal:3306)/diego
            max_open_connections: 100
        - name: routingdb
          manifest: |
            type: "mysql"
            schema: routing
            host: mysql.service.cf.internal
            port: 3306
            username: (( .mysql.routingdb_credentials.identity ))
            password: (( .mysql.routingdb_credentials.password ))

      - name: external
        select_value: external
        named_manifests:
          - name: ccdb
            manifest: |
              address: (( .properties.system_database.external.host.value ))
              port: (( .properties.system_database.external.port.value ))
              db_scheme: "mysql"
              roles:
              - tag: admin
                name: (( .properties.system_database.external.username.value ))
                password: (( .properties.system_database.external.password.value ))
              databases:
              - tag: cc
                name: ccdb
          - name: uaadb
            manifest: |
              address: (( .properties.system_database.external.host.value ))
              port: (( .properties.system_database.external.port.value ))
              db_scheme: "mysql"
              roles:
              - tag: admin
                name: (( .properties.system_database.external.username.value ))
                password: (( .properties.system_database.external.password.value ))
              databases:
              - tag: uaa
                name: uaa
          - name: notifications
            manifest: |
              url: mysql://(( .properties.system_database.external.username.value )):(( .properties.system_database.external.password.value ))@(( .properties.system_database.external.host.value )):(( .properties.system_database.external.port.value ))/notifications
              max_open_connections: 10
          - name: autoscaling
            manifest: |
              url: mysql://(( .properties.system_database.external.username.value )):(( .properties.system_database.external.password.value ))@(( .properties.system_database.external.host.value )):(( .properties.system_database.external.port.value ))/autoscale
          - name: console
            manifest: |
              ip: (( .properties.system_database.external.host.value ))
              port: (( .properties.system_database.external.port.value ))
              username: (( .properties.system_database.external.username.value ))
              password: (( .properties.system_database.external.password.value ))
              adapter: mysql
          - name: push-app-usage-service
            manifest: |
              name: app_usage_service
              port: (( .properties.system_database.external.port.value ))
              ip: (( .properties.system_database.external.host.value ))
              username: (( .properties.system_database.external.username.value ))
              password: (( .properties.system_database.external.password.value ))
          - name: diegodb
            manifest: |
              db_connection_string: mysql://(( .properties.system_database.external.username.value )):(( .properties.system_database.external.password.value ))@(( .properties.system_database.external.host.value )):(( .properties.system_database.external.port.value ))/diego
              max_open_connections: 100
          - name: routingdb
            manifest: |
              type: "mysql"
              schema: routing
              host: (( .properties.system_database.external.host.value ))
              port: (( .properties.system_database.external.port.value ))
              username: (( .properties.system_database.external.username.value ))
              password: (( .properties.system_database.external.password.value ))
        property_blueprints:
          - name: port
            type: port
            configurable: true
          - name: host
            type: string
            configurable: true
          - name: username
            type: string
            configurable: true
          - name: password
            type: secret
            configurable: true

  - name: mysql_backups
    type: selector
    configurable: true
    default: disable
    option_templates:
    - name: disable
      select_value: disable
      named_manifests:
      - name: destination
        manifest: |
          s3:
            endpoint_url:
            bucket_name:
            bucket_path:
            access_key_id:
            secret_access_key:
      - name: cron_schedule
        manifest: |

      - name: backup_all_masters
        manifest: |
          false
    - name: s3
      select_value: s3
      named_manifests:
      - name: destination
        manifest: |
          s3:
            endpoint_url: ((.properties.mysql_backups.s3.endpoint_url.value ))
            bucket_name: (( .properties.mysql_backups.s3.bucket_name.value ))
            bucket_path: (( .properties.mysql_backups.s3.bucket_path.value ))
            access_key_id: (( .properties.mysql_backups.s3.access_key_id.value ))
            secret_access_key: (( .properties.mysql_backups.s3.secret_access_key.value ))
      - name: cron_schedule
        manifest: |
          (( .properties.mysql_backups.s3.cron_schedule.value ))
      - name: backup_all_masters
        manifest: |
          (( .properties.mysql_backups.s3.backup_all_masters.value ))
      property_blueprints:
      - name: endpoint_url
        type: string
        configurable: true
        default: https://s3.amazonaws.com
      - name: bucket_name
        type: string
        configurable: true
      - name: bucket_path
        type: string
        configurable: true
      - name: access_key_id
        type: string
        configurable: true
      - name: secret_access_key
        type: secret
        configurable: true
      - name: cron_schedule
        type: string
        configurable: true
      - name: backup_all_masters
        type: boolean
        configurable: true
        default: true
    - name: scp
      select_value: scp
      named_manifests:
      - name: destination
        manifest: |
          scp:
            server: ((.properties.mysql_backups.scp.server.value ))
            port: ((.properties.mysql_backups.scp.port.value ))
            user: ((.properties.mysql_backups.scp.user.value ))
            key: ((.properties.mysql_backups.scp.key.value ))
            destination: ((.properties.mysql_backups.scp.destination.value ))
      - name: cron_schedule
        manifest: |
          (( .properties.mysql_backups.scp.cron_schedule.value ))
      - name: backup_all_masters
        manifest: |
          (( .properties.mysql_backups.scp.backup_all_masters.value ))
      property_blueprints:
      - name: server
        type: string
        configurable: true
      - name: port
        type: port
        configurable: true
        default: 22
      - name: user
        type: string
        configurable: true
      - name: key
        type: text
        configurable: true
      - name: destination
        type: string
        configurable: true
      - name: cron_schedule
        type: string
        configurable: true
      - name: backup_all_masters
        type: boolean
        configurable: true
        default: true
