---
resources:
  - name: p-runtime
    type: git
    source:
      uri: git@github.com:pivotal-cf/p-runtime.git
      branch: master
      private_key: |
        -----BEGIN RSA PRIVATE KEY-----
        MIIEowIBAAKCAQEAni+28XidxNTpNlZhnb3QXGrTssVLviDtl3fSjXM5Pml8E01b
        seLKMSp4Q080DOuUXlMsmvlx5ZJYmWeyR1V24l2iw1N6Ww9WaCTBBb6K69CkWi6R
        AoDNg1EkrsThGxNTUD6BFUzI64FydgCKv0GpX+I7LyMJSPGVZKi34lIDKfn2uGyE
        xZLPt833LvctrRW9g154Dc1Ok/SWqxL4I8uZFBSiNJqdXCx4dtXvnpRJ9da/SejB
        YmfWOBlVXjivOaJmz4m4jOkYJj8cOLoDGJBADgCBB1vdkbRuXShks2ft/PuxPVsm
        ZXpfOQxT0Qr9v4B0zubXncrloJvRduMV9IoccwIDAQABAoIBAHCpYw5P7W3GheKh
        WxzRl5h6rRPh2LQtF4qNWHRN4DNHRYspyWjEMWUa7lRiEJwzHJShgF9P0YLD3D5F
        0H9lqypFriqXRcmc/tllc+P3dVHGY4enKrgxrC0emZWvuvNhrDC2k5DsAx1YMIFC
        mY7l4Q/dPHGx7mb5SIFMeMrDxmUZ95EuCFBFpuyzgQvdS1Y2Kev7qfgu8oqxgGIN
        jMYy0m02LVq9A/dRulx7oWhjoCmZ8vFRD7YiHJj4QhQ909OjtesMoCU5cXzUarPL
        1tw+ki6h8l+HPToojVQsacSSdIQUvc2TYufyh0S5orSnc92fpZRyZmHjcnv4fkwx
        gDDzLsECgYEAzsjVaZkXXjMk/c1nFpMFaXWRKK8UYUnOh9uGp3WXa+spMEcAzbTW
        umHqJcQAGewkAk4PafM4BwqmcwL0zmoKxoDVGAGVLoezH/ln8KKZl94sfAsEbWlI
        VIs7SPfCGmo0ROHm+eDFiWS4+GJgLS+FLvqeHSXnhg4dgVqRHDlf05kCgYEAw9XZ
        AElXqouZ6i5jto2mO7DAkzRgR9IZ4xb9uLbOUAq1BgebWpwuT1L++WqTyiu8MNKr
        o1iJSAUIjbyxxICSjMRenF2kpziWmysfjiCjDt/Lw90+8109hz7A3qahJcjqjvEG
        FYIykaYTCWRM6kpUXogMS1kvrFwt6v4Rc84lN+sCgYA68jEz6vooVjgDSZxLaRmv
        2F3K1S3gFeQUAlY+Ql0p3F1fb74g5Z4Yf3T50wecXB5fsdTfBQBBsZ2FR6B1fvEX
        aP5V242lN/Wt9bDVfeR+0EyqB5H5hnuh7ha2VDo2wXOo9ySasqJc6iN4WsLD3rn+
        jF6qPHXlVvy+NQ0MmKZicQKBgG5PozCaH5udj1FuWBSYra6p3ZANzL4oBxT3+mt1
        7bkAjv+agVQE7cEZCy8LbbxP7m3B/ZTBZnL/AtZ0F96MXgCVDIYf6YOYSJ2XKOsy
        TyctwOXPVopXVzU7kADa86MJDbb+5WJwOHP6jHaZ3QmMXQHyuJoo3sXEFslr3ADT
        efuJAoGBAJcIUJRJdWBj3D7iLPOHRqJCwXdcxEaV9px9J+QUfnRZ4lGp5cdLlzcl
        KDZ97Z8GkcNEWmVNqygX06AgJmHhNNDRXJCT5fwcJlF8ZcjXZ6NJa3zVQ3y1VMFE
        hYI0vHHTGhvOQR1PYJlS5JuNvDCWo8PeeG/LV+zUEVW7LJMYzvWj
        -----END RSA PRIVATE KEY-----

  - name: ert-product
    type: s3
    source:
      access_key_id: AKIAI43577ARGHXPWIMQ
      secret_access_key: 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
      bucket: ert-concourse-products
      region_name: us-west-1
      private: true
      versioned_file: ert-1.6/tested/ert.pivotal

  - name: latest-opsman-aws
    type: s3
    source:
      access_key_id: AKIAI43577ARGHXPWIMQ
      secret_access_key: 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
      bucket: ert-concourse-products
      region_name: us-west-1
      private: true
      versioned_file: ops_manager_images/aws/latest/ops_man_image

  - name: stable-opsman-aws
    type: s3
    source:
      access_key_id: AKIAI43577ARGHXPWIMQ
      secret_access_key: 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
      bucket: ert-concourse-products
      region_name: us-west-1
      private: true
      versioned_file: ops_manager_images/aws/stable/ops_man_image

  - name: environment-aws
    type: pool
    source:
      uri: git@github.com:pivotal-cf-experimental/releng-env-resource-pool
      branch: master
      pool: aws
      private_key: |
        -----BEGIN RSA PRIVATE KEY-----
        MIIEowIBAAKCAQEAusDLytuEM/eX5vkwEFlTTKhnpDpUrKtxIOqcfGwg2gyH29jm
        RGIYLAIYGqfsAXP1pbd/EMSE3CgzQUcwRiNTNRZTAXC3QXioz52xhziI7NrSu71P
        LuwMuj7YtqjFdsFt57ho5O8iGXCmcwHdLvN4ADByRn4p4aMg59IK5aG8B+Btn0gz
        dJBTz8Px1LkdVpSitZPrZdpjDoYymSABfQ/oTvMSTffiiOC634EFCkJmr9Uc1M2C
        mX2LwtM/ZDVnpmY/hWjI3dNhEolvVl1TAQzfokoszJiFMSKPRJhF5SctdnBmzgDC
        GOuxdU1Jtrhj22CxvzRGoVFI1BrxNcDzg3fBBwIDAQABAoIBAG6cvNgVNvOUxbr/
        gxFb5vOzl1d1WSvAi8wESdWEMd0UqO91Q8XjGBAQ2XgIV8fwh+G0kqU60LqZcOpM
        IPKZ/7Gk3FsxCMnVjp8R9tFxkeBAJ6sdEKZpF4zEppVh1ztkjBVAa5iVbuwEhgH+
        a6RgfoYWK8lG9sV3WokUJnImXnmG1vAq55B1/M7FuboHKO/1raE7w3rnydqpGOlm
        rdTTR9VghuJSI+zcPy90k/tWxqQW5fohjmvdFp3Tjlu68Gz9wYgBzlBfOsE0Oo64
        ssMw0j2wAdbz6E3/g4w0k5j7c3UFECVyqfciY1u3CbXNAZz+UXvF6mgV6hGFsLha
        55T1SFECgYEA8ed76C56IIGAVz9n+QltdRFijZyZXDrrmp4m5wTrjBabG+0quZ5e
        CwYhr5J86G/HQiM/dVMlX8xUW7dLkJanLaeBaG+VA8VWvijcRRMG4CaRIeYquLCW
        kJSW9fgcH+0zr2GxKoxA81dDSgSmu0rz+JXVxBZrzRAEesCTxwwuwV8CgYEAxaKd
        osZDsqheY78/wDox3x8OVdkPgYtV7ckGXVA6YiNbFIS815Dtxun5RBjYC5AuLslu
        ml+B/N5B+ezdGPCd1Xo+aoAG4SWbqRRQ4YhbXjfCW5+ve9vHAPb0Lsnq6YzmjRRa
        n26QmLxlkXk9xs8eIH+yG4qEtOpwheqNDzzT2VkCgYAMAsheMOCTeJqcumM5NESh
        CWnxShM7Rxmnpa6czdu8KussqcvzR2+38Gf/xbA6AkLMf9+IvcYfSY/utd0korZO
        SADe5JtrgoLaEkFNlLJEsuWF313DqdDwANC2CcmrtCVa0ejwCeK3sl9+71gv+HrA
        nv/sKojTt7XhOmqb+Xjg1QKBgFDNwtupakZidm0b5YnHgVpzTR4maCOT/2cAGN0Q
        Dz7Oq8+A0eDk/YKlaOfBrJtVsLwqWVE+mVv0107C3Eb1IeMFXv2WKLnm8XS4vLTp
        Vkn4TDu/1zSxz/SCA6YZojUpCZ5G4yJqRy5bYL+QrYRabDvnWb/O66E4dRcbpd7E
        BO3JAoGBAKjGoOR90tzEtLrEvAYQ7C4hBaAEr5Q9qVTY8YX3Buu7IjOXnp+hPjM2
        NsvohmptLBEY+xFa+uM7I7yzlp3NeLNeM37UyCQiEjuyoTotN1hjRLiWUWi6KrYS
        1SYykNNYKIkR5x7VO2kGNs68zwiBCxllIqCKQZJeeJvctQVewYLs
        -----END RSA PRIVATE KEY-----

  - name: latest-opsman-openstack
    type: s3
    source:
      access_key_id: AKIAI43577ARGHXPWIMQ
      secret_access_key: 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
      bucket: ert-concourse-products
      region_name: us-west-1
      private: true
      versioned_file: ops_manager_images/openstack/latest/ops_man_image

  - name: stable-opsman-openstack
    type: s3
    source:
      access_key_id: AKIAI43577ARGHXPWIMQ
      secret_access_key: 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
      bucket: ert-concourse-products
      region_name: us-west-1
      private: true
      versioned_file: ops_manager_images/openstack/stable/ops_man_image

  - name: environment-openstack
    type: pool
    source:
      uri: git@github.com:pivotal-cf-experimental/releng-env-resource-pool
      branch: master
      pool: openstack
      private_key: |
        -----BEGIN RSA PRIVATE KEY-----
        MIIEowIBAAKCAQEAusDLytuEM/eX5vkwEFlTTKhnpDpUrKtxIOqcfGwg2gyH29jm
        RGIYLAIYGqfsAXP1pbd/EMSE3CgzQUcwRiNTNRZTAXC3QXioz52xhziI7NrSu71P
        LuwMuj7YtqjFdsFt57ho5O8iGXCmcwHdLvN4ADByRn4p4aMg59IK5aG8B+Btn0gz
        dJBTz8Px1LkdVpSitZPrZdpjDoYymSABfQ/oTvMSTffiiOC634EFCkJmr9Uc1M2C
        mX2LwtM/ZDVnpmY/hWjI3dNhEolvVl1TAQzfokoszJiFMSKPRJhF5SctdnBmzgDC
        GOuxdU1Jtrhj22CxvzRGoVFI1BrxNcDzg3fBBwIDAQABAoIBAG6cvNgVNvOUxbr/
        gxFb5vOzl1d1WSvAi8wESdWEMd0UqO91Q8XjGBAQ2XgIV8fwh+G0kqU60LqZcOpM
        IPKZ/7Gk3FsxCMnVjp8R9tFxkeBAJ6sdEKZpF4zEppVh1ztkjBVAa5iVbuwEhgH+
        a6RgfoYWK8lG9sV3WokUJnImXnmG1vAq55B1/M7FuboHKO/1raE7w3rnydqpGOlm
        rdTTR9VghuJSI+zcPy90k/tWxqQW5fohjmvdFp3Tjlu68Gz9wYgBzlBfOsE0Oo64
        ssMw0j2wAdbz6E3/g4w0k5j7c3UFECVyqfciY1u3CbXNAZz+UXvF6mgV6hGFsLha
        55T1SFECgYEA8ed76C56IIGAVz9n+QltdRFijZyZXDrrmp4m5wTrjBabG+0quZ5e
        CwYhr5J86G/HQiM/dVMlX8xUW7dLkJanLaeBaG+VA8VWvijcRRMG4CaRIeYquLCW
        kJSW9fgcH+0zr2GxKoxA81dDSgSmu0rz+JXVxBZrzRAEesCTxwwuwV8CgYEAxaKd
        osZDsqheY78/wDox3x8OVdkPgYtV7ckGXVA6YiNbFIS815Dtxun5RBjYC5AuLslu
        ml+B/N5B+ezdGPCd1Xo+aoAG4SWbqRRQ4YhbXjfCW5+ve9vHAPb0Lsnq6YzmjRRa
        n26QmLxlkXk9xs8eIH+yG4qEtOpwheqNDzzT2VkCgYAMAsheMOCTeJqcumM5NESh
        CWnxShM7Rxmnpa6czdu8KussqcvzR2+38Gf/xbA6AkLMf9+IvcYfSY/utd0korZO
        SADe5JtrgoLaEkFNlLJEsuWF313DqdDwANC2CcmrtCVa0ejwCeK3sl9+71gv+HrA
        nv/sKojTt7XhOmqb+Xjg1QKBgFDNwtupakZidm0b5YnHgVpzTR4maCOT/2cAGN0Q
        Dz7Oq8+A0eDk/YKlaOfBrJtVsLwqWVE+mVv0107C3Eb1IeMFXv2WKLnm8XS4vLTp
        Vkn4TDu/1zSxz/SCA6YZojUpCZ5G4yJqRy5bYL+QrYRabDvnWb/O66E4dRcbpd7E
        BO3JAoGBAKjGoOR90tzEtLrEvAYQ7C4hBaAEr5Q9qVTY8YX3Buu7IjOXnp+hPjM2
        NsvohmptLBEY+xFa+uM7I7yzlp3NeLNeM37UyCQiEjuyoTotN1hjRLiWUWi6KrYS
        1SYykNNYKIkR5x7VO2kGNs68zwiBCxllIqCKQZJeeJvctQVewYLs
        -----END RSA PRIVATE KEY-----
  - name: latest-opsman-vsphere
    type: s3
    source:
      access_key_id: AKIAI43577ARGHXPWIMQ
      secret_access_key: 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
      bucket: ert-concourse-products
      region_name: us-west-1
      private: true
      versioned_file: ops_manager_images/vsphere/latest/ops_man_image

  - name: stable-opsman-vsphere
    type: s3
    source:
      access_key_id: AKIAI43577ARGHXPWIMQ
      secret_access_key: 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
      bucket: ert-concourse-products
      region_name: us-west-1
      private: true
      versioned_file: ops_manager_images/vsphere/stable/ops_man_image

  - name: environment-vsphere
    type: pool
    source:
      uri: git@github.com:pivotal-cf-experimental/releng-env-resource-pool
      branch: master
      pool: vsphere
      private_key: |
        -----BEGIN RSA PRIVATE KEY-----
        MIIEowIBAAKCAQEAusDLytuEM/eX5vkwEFlTTKhnpDpUrKtxIOqcfGwg2gyH29jm
        RGIYLAIYGqfsAXP1pbd/EMSE3CgzQUcwRiNTNRZTAXC3QXioz52xhziI7NrSu71P
        LuwMuj7YtqjFdsFt57ho5O8iGXCmcwHdLvN4ADByRn4p4aMg59IK5aG8B+Btn0gz
        dJBTz8Px1LkdVpSitZPrZdpjDoYymSABfQ/oTvMSTffiiOC634EFCkJmr9Uc1M2C
        mX2LwtM/ZDVnpmY/hWjI3dNhEolvVl1TAQzfokoszJiFMSKPRJhF5SctdnBmzgDC
        GOuxdU1Jtrhj22CxvzRGoVFI1BrxNcDzg3fBBwIDAQABAoIBAG6cvNgVNvOUxbr/
        gxFb5vOzl1d1WSvAi8wESdWEMd0UqO91Q8XjGBAQ2XgIV8fwh+G0kqU60LqZcOpM
        IPKZ/7Gk3FsxCMnVjp8R9tFxkeBAJ6sdEKZpF4zEppVh1ztkjBVAa5iVbuwEhgH+
        a6RgfoYWK8lG9sV3WokUJnImXnmG1vAq55B1/M7FuboHKO/1raE7w3rnydqpGOlm
        rdTTR9VghuJSI+zcPy90k/tWxqQW5fohjmvdFp3Tjlu68Gz9wYgBzlBfOsE0Oo64
        ssMw0j2wAdbz6E3/g4w0k5j7c3UFECVyqfciY1u3CbXNAZz+UXvF6mgV6hGFsLha
        55T1SFECgYEA8ed76C56IIGAVz9n+QltdRFijZyZXDrrmp4m5wTrjBabG+0quZ5e
        CwYhr5J86G/HQiM/dVMlX8xUW7dLkJanLaeBaG+VA8VWvijcRRMG4CaRIeYquLCW
        kJSW9fgcH+0zr2GxKoxA81dDSgSmu0rz+JXVxBZrzRAEesCTxwwuwV8CgYEAxaKd
        osZDsqheY78/wDox3x8OVdkPgYtV7ckGXVA6YiNbFIS815Dtxun5RBjYC5AuLslu
        ml+B/N5B+ezdGPCd1Xo+aoAG4SWbqRRQ4YhbXjfCW5+ve9vHAPb0Lsnq6YzmjRRa
        n26QmLxlkXk9xs8eIH+yG4qEtOpwheqNDzzT2VkCgYAMAsheMOCTeJqcumM5NESh
        CWnxShM7Rxmnpa6czdu8KussqcvzR2+38Gf/xbA6AkLMf9+IvcYfSY/utd0korZO
        SADe5JtrgoLaEkFNlLJEsuWF313DqdDwANC2CcmrtCVa0ejwCeK3sl9+71gv+HrA
        nv/sKojTt7XhOmqb+Xjg1QKBgFDNwtupakZidm0b5YnHgVpzTR4maCOT/2cAGN0Q
        Dz7Oq8+A0eDk/YKlaOfBrJtVsLwqWVE+mVv0107C3Eb1IeMFXv2WKLnm8XS4vLTp
        Vkn4TDu/1zSxz/SCA6YZojUpCZ5G4yJqRy5bYL+QrYRabDvnWb/O66E4dRcbpd7E
        BO3JAoGBAKjGoOR90tzEtLrEvAYQ7C4hBaAEr5Q9qVTY8YX3Buu7IjOXnp+hPjM2
        NsvohmptLBEY+xFa+uM7I7yzlp3NeLNeM37UyCQiEjuyoTotN1hjRLiWUWi6KrYS
        1SYykNNYKIkR5x7VO2kGNs68zwiBCxllIqCKQZJeeJvctQVewYLs
        -----END RSA PRIVATE KEY-----

  - name: latest-opsman-vcloud
    type: s3
    source:
      access_key_id: AKIAI43577ARGHXPWIMQ
      secret_access_key: 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
      bucket: ert-concourse-products
      region_name: us-west-1
      private: true
      versioned_file: ops_manager_images/vcloud/latest/ops_man_image

  - name: stable-opsman-vcloud
    type: s3
    source:
      access_key_id: AKIAI43577ARGHXPWIMQ
      secret_access_key: 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
      bucket: ert-concourse-products
      region_name: us-west-1
      private: true
      versioned_file: ops_manager_images/vcloud/stable/ops_man_image

  - name: environment-vcloud
    type: pool
    source:
      uri: git@github.com:pivotal-cf-experimental/releng-env-resource-pool
      branch: master
      pool: vcloud
      private_key: |
        -----BEGIN RSA PRIVATE KEY-----
        MIIEowIBAAKCAQEAusDLytuEM/eX5vkwEFlTTKhnpDpUrKtxIOqcfGwg2gyH29jm
        RGIYLAIYGqfsAXP1pbd/EMSE3CgzQUcwRiNTNRZTAXC3QXioz52xhziI7NrSu71P
        LuwMuj7YtqjFdsFt57ho5O8iGXCmcwHdLvN4ADByRn4p4aMg59IK5aG8B+Btn0gz
        dJBTz8Px1LkdVpSitZPrZdpjDoYymSABfQ/oTvMSTffiiOC634EFCkJmr9Uc1M2C
        mX2LwtM/ZDVnpmY/hWjI3dNhEolvVl1TAQzfokoszJiFMSKPRJhF5SctdnBmzgDC
        GOuxdU1Jtrhj22CxvzRGoVFI1BrxNcDzg3fBBwIDAQABAoIBAG6cvNgVNvOUxbr/
        gxFb5vOzl1d1WSvAi8wESdWEMd0UqO91Q8XjGBAQ2XgIV8fwh+G0kqU60LqZcOpM
        IPKZ/7Gk3FsxCMnVjp8R9tFxkeBAJ6sdEKZpF4zEppVh1ztkjBVAa5iVbuwEhgH+
        a6RgfoYWK8lG9sV3WokUJnImXnmG1vAq55B1/M7FuboHKO/1raE7w3rnydqpGOlm
        rdTTR9VghuJSI+zcPy90k/tWxqQW5fohjmvdFp3Tjlu68Gz9wYgBzlBfOsE0Oo64
        ssMw0j2wAdbz6E3/g4w0k5j7c3UFECVyqfciY1u3CbXNAZz+UXvF6mgV6hGFsLha
        55T1SFECgYEA8ed76C56IIGAVz9n+QltdRFijZyZXDrrmp4m5wTrjBabG+0quZ5e
        CwYhr5J86G/HQiM/dVMlX8xUW7dLkJanLaeBaG+VA8VWvijcRRMG4CaRIeYquLCW
        kJSW9fgcH+0zr2GxKoxA81dDSgSmu0rz+JXVxBZrzRAEesCTxwwuwV8CgYEAxaKd
        osZDsqheY78/wDox3x8OVdkPgYtV7ckGXVA6YiNbFIS815Dtxun5RBjYC5AuLslu
        ml+B/N5B+ezdGPCd1Xo+aoAG4SWbqRRQ4YhbXjfCW5+ve9vHAPb0Lsnq6YzmjRRa
        n26QmLxlkXk9xs8eIH+yG4qEtOpwheqNDzzT2VkCgYAMAsheMOCTeJqcumM5NESh
        CWnxShM7Rxmnpa6czdu8KussqcvzR2+38Gf/xbA6AkLMf9+IvcYfSY/utd0korZO
        SADe5JtrgoLaEkFNlLJEsuWF313DqdDwANC2CcmrtCVa0ejwCeK3sl9+71gv+HrA
        nv/sKojTt7XhOmqb+Xjg1QKBgFDNwtupakZidm0b5YnHgVpzTR4maCOT/2cAGN0Q
        Dz7Oq8+A0eDk/YKlaOfBrJtVsLwqWVE+mVv0107C3Eb1IeMFXv2WKLnm8XS4vLTp
        Vkn4TDu/1zSxz/SCA6YZojUpCZ5G4yJqRy5bYL+QrYRabDvnWb/O66E4dRcbpd7E
        BO3JAoGBAKjGoOR90tzEtLrEvAYQ7C4hBaAEr5Q9qVTY8YX3Buu7IjOXnp+hPjM2
        NsvohmptLBEY+xFa+uM7I7yzlp3NeLNeM37UyCQiEjuyoTotN1hjRLiWUWi6KrYS
        1SYykNNYKIkR5x7VO2kGNs68zwiBCxllIqCKQZJeeJvctQVewYLs
        -----END RSA PRIVATE KEY-----
jobs:
  - name: claim-environment-aws
    plan:
      - get: p-runtime
      - get: ops-manager
        resource: latest-opsman-aws
        trigger: true
      - put: environment
        resource: environment-aws
        params:
          acquire: true
      - task: update-krafa
        file: p-runtime/ci/jobs/update-krafa.yml
        config:
          params:
            CLAIM_REASON: aws-edge
            KRAFA_BASE_URL: http://krafa.cfapps.io
            KRAFA_USERNAME: releng
            KRAFA_PASSWORD: bet90onions

  - name: destroy-environment-aws
    plan:
      - get: p-runtime
        passed: [claim-environment-aws]
      - get: environment
        resource: environment-aws
        trigger: true
        passed: [claim-environment-aws]
      - task: destroy
        tags: [aws]
        file: p-runtime/ci/jobs/destroy-environment.yml

  - name: deploy-ops-manager-aws
    plan:
      - get: p-runtime
        passed: [destroy-environment-aws, claim-environment-aws]
      - get: environment
        resource: environment-aws
        trigger: true
        passed: [destroy-environment-aws]
      - aggregate:
        - get: ops-manager
          resource: latest-opsman-aws
          passed: [claim-environment-aws]
        - task: prepare
          tags: [aws]
          file: p-runtime/ci/jobs/prepare-environment.yml
      - task: deploy
        tags: [aws]
        file: p-runtime/ci/jobs/deploy-opsman.yml

  - name: configure-microbosh-aws
    plan:
      - get: p-runtime
        passed: [deploy-ops-manager-aws]
      - get: environment
        resource: environment-aws
        trigger: true
        passed: [deploy-ops-manager-aws]
      - task: configure
        tags: [aws]
        file: p-runtime/ci/jobs/configure-microbosh.yml
        config:
          params:
            OPSMAN_VERSION: &om_version 1.5

  - name: deploy-microbosh-aws
    plan:
      - get: p-runtime
        passed: [configure-microbosh-aws]
      - get: environment
        resource: environment-aws
        trigger: true
        passed: [configure-microbosh-aws]
      - task: deploy
        tags: [aws]
        file: p-runtime/ci/jobs/deploy-microbosh.yml
        config:
          params:
            OPSMAN_VERSION: *om_version
        ensure:
          task: get-install-log
          tags: [aws]
          file: p-runtime/ci/jobs/get-install-log.yml
          config:
            params:
              OPSMAN_VERSION: *om_version

  - name: upload-pivotal-aws
    plan:
      - aggregate:
        - get: p-runtime
          passed: [deploy-microbosh-aws]
        - get: environment
          resource: environment-aws
          trigger: true
          passed: [deploy-microbosh-aws]
        - get: ert-product
      - task: upload-pivotal
        tags: [aws]
        file: p-runtime/ci/jobs/upload-pivotal.yml
        config:
          params:
            OPSMAN_VERSION: *om_version


  - name: configure-ert-aws
    plan:
      - get: p-runtime
        passed: [upload-pivotal-aws]
      - get: environment
        resource: environment-aws
        trigger: true
        passed: [upload-pivotal-aws]
      - task: configure-ert
        tags: [aws]
        file: p-runtime/ci/jobs/configure-ert.yml
        config:
          params:
            ERT_VERSION: &ert_version 1.6
            OPSMAN_VERSION: *om_version
      - task: create-external-dbs
        tags: [aws]
        file: p-runtime/ci/jobs/create-aws-dbs.yml
      - task: configure-external-dbs
        tags: [aws]
        file: p-runtime/ci/jobs/configure-external-dbs.yml
        config:
          params:
            ERT_VERSION: *ert_version
            OPSMAN_VERSION: *om_version
      - task: configure-external-file-storage
        tags: [aws]
        file: p-runtime/ci/jobs/configure-external-file-storage.yml
        config:
          params:
            ERT_VERSION: *ert_version
            OPSMAN_VERSION: *om_version


  - name: deploy-ert-aws
    plan:
      - get: p-runtime
        passed: [configure-ert-aws]
      - get: environment
        resource: environment-aws
        trigger: true
        passed: [configure-ert-aws]
      - task: deploy-ert
        tags: [aws]
        file: p-runtime/ci/jobs/deploy-ert.yml
        config:
          params:
            OPSMAN_VERSION: *om_version
        ensure:
          task: get-install-log
          tags: [aws]
          file: p-runtime/ci/jobs/get-install-log.yml
          config:
            params:
              OPSMAN_VERSION: *om_version

  - name: run-cats-aws
    plan:
      - get: p-runtime
        passed: [deploy-ert-aws]
      - get: environment
        resource: environment-aws
        trigger: true
        passed: [deploy-ert-aws]
      - task: run-cats
        tags: [aws]
        file: p-runtime/ci/jobs/run-cats.yml
        config:
          params:
            OPSMAN_VERSION: *om_version

  - name: promote-ops-manager-aws
    plan:
     - get: p-runtime
       trigger: true
       passed: [run-cats-aws, claim-environment-aws]
     - get: latest-opsman-aws
       passed: [claim-environment-aws]
     - put: stable-opsman-aws
       params:
         from: latest-opsman-aws/ops_man_image

  - name: destroy-environment-final-aws
    plan:
     - get: p-runtime
       passed: [run-cats-aws]
     - get: environment
       resource: environment-aws
       passed: [run-cats-aws]
     - task: destroy
       tags: [aws]
       file: p-runtime/ci/jobs/destroy-environment.yml

  - name: release-environment-aws
    plan:
      - get: p-runtime
        passed: [destroy-environment-final-aws]
      - get: environment
        resource: environment-aws
        trigger: true
        passed: [destroy-environment-final-aws]
      - put: environment-aws
        params:
          release: environment

  - name: claim-environment-openstack
    plan:
      - get: p-runtime
      - get: ops-manager
        resource: latest-opsman-openstack
        trigger: true
      - put: environment
        resource: environment-openstack
        params:
          acquire: true
      - task: update-krafa
        file: p-runtime/ci/jobs/update-krafa.yml
        config:
          params:
            CLAIM_REASON: openstack-edge
            KRAFA_BASE_URL: http://krafa.cfapps.io
            KRAFA_USERNAME: releng
            KRAFA_PASSWORD: bet90onions

  - name: destroy-environment-openstack
    plan:
      - get: p-runtime
        passed: [claim-environment-openstack]
      - get: environment
        resource: environment-openstack
        trigger: true
        passed: [claim-environment-openstack]
      - task: destroy
        tags: [openstack]
        file: p-runtime/ci/jobs/destroy-environment.yml

  - name: deploy-ops-manager-openstack
    plan:
      - get: p-runtime
        passed: [destroy-environment-openstack, claim-environment-openstack]
      - get: environment
        resource: environment-openstack
        trigger: true
        passed: [destroy-environment-openstack]
      - aggregate:
        - get: ops-manager
          resource: latest-opsman-openstack
          passed: [claim-environment-openstack]
        - task: prepare
          tags: [openstack]
          file: p-runtime/ci/jobs/prepare-environment.yml
      - task: deploy
        tags: [openstack]
        file: p-runtime/ci/jobs/deploy-opsman.yml

  - name: configure-microbosh-openstack
    plan:
      - get: p-runtime
        passed: [deploy-ops-manager-openstack]
      - get: environment
        resource: environment-openstack
        trigger: true
        passed: [deploy-ops-manager-openstack]
      - task: configure
        tags: [openstack]
        file: p-runtime/ci/jobs/configure-microbosh.yml
        config:
          params:
            OPSMAN_VERSION: &om_version 1.5

  - name: deploy-microbosh-openstack
    plan:
      - get: p-runtime
        passed: [configure-microbosh-openstack]
      - get: environment
        resource: environment-openstack
        trigger: true
        passed: [configure-microbosh-openstack]
      - task: deploy
        tags: [openstack]
        file: p-runtime/ci/jobs/deploy-microbosh.yml
        config:
          params:
            OPSMAN_VERSION: *om_version
        ensure:
          task: get-install-log
          tags: [openstack]
          file: p-runtime/ci/jobs/get-install-log.yml
          config:
            params:
              OPSMAN_VERSION: *om_version

  - name: upload-pivotal-openstack
    plan:
      - aggregate:
        - get: p-runtime
          passed: [deploy-microbosh-openstack]
        - get: environment
          resource: environment-openstack
          trigger: true
          passed: [deploy-microbosh-openstack]
        - get: ert-product
      - task: upload-pivotal
        tags: [openstack]
        file: p-runtime/ci/jobs/upload-pivotal.yml
        config:
          params:
            OPSMAN_VERSION: *om_version


  - name: configure-ert-openstack
    plan:
      - get: p-runtime
        passed: [upload-pivotal-openstack]
      - get: environment
        resource: environment-openstack
        trigger: true
        passed: [upload-pivotal-openstack]
      - task: configure-ert
        tags: [openstack]
        file: p-runtime/ci/jobs/configure-ert.yml
        config:
          params:
            ERT_VERSION: 1.6
            OPSMAN_VERSION: *om_version


  - name: deploy-ert-openstack
    plan:
      - get: p-runtime
        passed: [configure-ert-openstack]
      - get: environment
        resource: environment-openstack
        trigger: true
        passed: [configure-ert-openstack]
      - task: deploy-ert
        tags: [openstack]
        file: p-runtime/ci/jobs/deploy-ert.yml
        config:
          params:
            OPSMAN_VERSION: *om_version
        ensure:
          task: get-install-log
          tags: [openstack]
          file: p-runtime/ci/jobs/get-install-log.yml
          config:
            params:
              OPSMAN_VERSION: *om_version

  - name: run-cats-openstack
    plan:
      - get: p-runtime
        passed: [deploy-ert-openstack]
      - get: environment
        resource: environment-openstack
        trigger: true
        passed: [deploy-ert-openstack]
      - task: run-cats
        tags: [openstack]
        file: p-runtime/ci/jobs/run-cats.yml
        config:
          params:
            OPSMAN_VERSION: *om_version

  - name: promote-ops-manager-openstack
    plan:
     - get: p-runtime
       trigger: true
       passed: [run-cats-openstack, claim-environment-openstack]
     - get: latest-opsman-openstack
       passed: [claim-environment-openstack]
     - put: stable-opsman-openstack
       params:
         from: latest-opsman-openstack/ops_man_image

  - name: destroy-environment-final-openstack
    plan:
     - get: p-runtime
       passed: [run-cats-openstack]
     - get: environment
       resource: environment-openstack
       passed: [run-cats-openstack]
     - task: destroy
       tags: [openstack]
       file: p-runtime/ci/jobs/destroy-environment.yml

  - name: release-environment-openstack
    plan:
      - get: p-runtime
        passed: [destroy-environment-final-openstack]
      - get: environment
        resource: environment-openstack
        trigger: true
        passed: [destroy-environment-final-openstack]
      - put: environment-openstack
        params:
          release: environment

  - name: claim-environment-vsphere
    plan:
      - get: p-runtime
      - get: ops-manager
        resource: latest-opsman-vsphere
        trigger: true
      - put: environment
        resource: environment-vsphere
        params:
          acquire: true
      - task: update-krafa
        file: p-runtime/ci/jobs/update-krafa.yml
        config:
          params:
            CLAIM_REASON: vsphere-edge
            KRAFA_BASE_URL: http://krafa.cfapps.io
            KRAFA_USERNAME: releng
            KRAFA_PASSWORD: bet90onions

  - name: destroy-environment-vsphere
    plan:
      - get: p-runtime
        passed: [claim-environment-vsphere]
      - get: environment
        resource: environment-vsphere
        trigger: true
        passed: [claim-environment-vsphere]
      - task: destroy
        tags: [vsphere]
        file: p-runtime/ci/jobs/destroy-environment.yml

  - name: deploy-ops-manager-vsphere
    plan:
      - get: p-runtime
        passed: [destroy-environment-vsphere, claim-environment-vsphere]
      - get: environment
        resource: environment-vsphere
        trigger: true
        passed: [destroy-environment-vsphere]
      - aggregate:
        - get: ops-manager
          resource: latest-opsman-vsphere
          passed: [claim-environment-vsphere]
        - task: prepare
          tags: [vsphere]
          file: p-runtime/ci/jobs/prepare-environment.yml
      - task: deploy
        tags: [vsphere]
        file: p-runtime/ci/jobs/deploy-opsman.yml

  - name: configure-microbosh-vsphere
    plan:
      - get: p-runtime
        passed: [deploy-ops-manager-vsphere]
      - get: environment
        resource: environment-vsphere
        trigger: true
        passed: [deploy-ops-manager-vsphere]
      - task: configure
        tags: [vsphere]
        file: p-runtime/ci/jobs/configure-microbosh.yml
        config:
          params:
            OPSMAN_VERSION: &om_version 1.5

  - name: deploy-microbosh-vsphere
    plan:
      - get: p-runtime
        passed: [configure-microbosh-vsphere]
      - get: environment
        resource: environment-vsphere
        trigger: true
        passed: [configure-microbosh-vsphere]
      - task: deploy
        tags: [vsphere]
        file: p-runtime/ci/jobs/deploy-microbosh.yml
        config:
          params:
            OPSMAN_VERSION: *om_version
        ensure:
          task: get-install-log
          tags: [vsphere]
          file: p-runtime/ci/jobs/get-install-log.yml
          config:
            params:
              OPSMAN_VERSION: *om_version

  - name: upload-pivotal-vsphere
    plan:
      - aggregate:
        - get: p-runtime
          passed: [deploy-microbosh-vsphere]
        - get: environment
          resource: environment-vsphere
          trigger: true
          passed: [deploy-microbosh-vsphere]
        - get: ert-product
      - task: upload-pivotal
        tags: [vsphere]
        file: p-runtime/ci/jobs/upload-pivotal.yml
        config:
          params:
            OPSMAN_VERSION: *om_version


  - name: configure-ert-vsphere
    plan:
      - get: p-runtime
        passed: [upload-pivotal-vsphere]
      - get: environment
        resource: environment-vsphere
        trigger: true
        passed: [upload-pivotal-vsphere]
      - task: configure-ert
        tags: [vsphere]
        file: p-runtime/ci/jobs/configure-ert.yml
        config:
          params:
            ERT_VERSION: 1.6
            OPSMAN_VERSION: *om_version


  - name: deploy-ert-vsphere
    plan:
      - get: p-runtime
        passed: [configure-ert-vsphere]
      - get: environment
        resource: environment-vsphere
        trigger: true
        passed: [configure-ert-vsphere]
      - task: deploy-ert
        tags: [vsphere]
        file: p-runtime/ci/jobs/deploy-ert.yml
        config:
          params:
            OPSMAN_VERSION: *om_version
        ensure:
          task: get-install-log
          tags: [vsphere]
          file: p-runtime/ci/jobs/get-install-log.yml
          config:
            params:
              OPSMAN_VERSION: *om_version

  - name: run-cats-vsphere
    plan:
      - get: p-runtime
        passed: [deploy-ert-vsphere]
      - get: environment
        resource: environment-vsphere
        trigger: true
        passed: [deploy-ert-vsphere]
      - task: run-cats
        tags: [vsphere]
        file: p-runtime/ci/jobs/run-cats.yml
        config:
          params:
            OPSMAN_VERSION: *om_version

  - name: promote-ops-manager-vsphere
    plan:
      - get: p-runtime
        trigger: true
        passed: [run-cats-vsphere, claim-environment-vsphere]
      - get: latest-opsman-vsphere
        passed: [claim-environment-vsphere]
      - put: stable-opsman-vsphere
        params:
          from: latest-opsman-vsphere/ops_man_image

  - name: destroy-environment-final-vsphere
    plan:
      - get: p-runtime
        passed: [run-cats-vsphere]
      - get: environment
        resource: environment-vsphere
        passed: [run-cats-vsphere]
      - task: destroy
        tags: [vsphere]
        file: p-runtime/ci/jobs/destroy-environment.yml

  - name: release-environment-vsphere
    plan:
      - get: p-runtime
        passed: [destroy-environment-final-vsphere]
      - get: environment
        resource: environment-vsphere
        trigger: true
        passed: [destroy-environment-final-vsphere]
      - put: environment-vsphere
        params:
          release: environment

  - name: claim-environment-vcloud
    plan:
      - get: p-runtime
      - get: ops-manager
        resource: latest-opsman-vcloud
        trigger: true
      - put: environment
        resource: environment-vcloud
        params:
          acquire: true
      - task: update-krafa
        file: p-runtime/ci/jobs/update-krafa.yml
        config:
          params:
            CLAIM_REASON: vcloud-edge
            KRAFA_BASE_URL: http://krafa.cfapps.io
            KRAFA_USERNAME: releng
            KRAFA_PASSWORD: bet90onions

  - name: destroy-environment-vcloud
    plan:
      - get: p-runtime
        passed: [claim-environment-vcloud]
      - get: environment
        resource: environment-vcloud
        trigger: true
        passed: [claim-environment-vcloud]
      - try:
          task: delete-installation
          tags: [vcloud]
          file: p-runtime/ci/jobs/delete-installation.yml
          config:
            params:
              OPSMAN_VERSION: *om_version
      - task: destroy
        tags: [vcloud]
        file: p-runtime/ci/jobs/destroy-environment.yml

  - name: deploy-ops-manager-vcloud
    plan:
      - get: p-runtime
        passed: [destroy-environment-vcloud, claim-environment-vcloud]
      - get: environment
        resource: environment-vcloud
        trigger: true
        passed: [destroy-environment-vcloud]
      - aggregate:
        - get: ops-manager
          resource: latest-opsman-vcloud
          passed: [claim-environment-vcloud]
        - task: prepare
          tags: [vcloud]
          file: p-runtime/ci/jobs/prepare-environment.yml
      - task: deploy
        tags: [vcloud]
        file: p-runtime/ci/jobs/deploy-opsman.yml

  - name: configure-microbosh-vcloud
    plan:
      - get: p-runtime
        passed: [deploy-ops-manager-vcloud]
      - get: environment
        resource: environment-vcloud
        trigger: true
        passed: [deploy-ops-manager-vcloud]
      - task: configure
        tags: [vcloud]
        file: p-runtime/ci/jobs/configure-microbosh.yml
        config:
          params:
            OPSMAN_VERSION: &om_version 1.5

  - name: deploy-microbosh-vcloud
    plan:
      - get: p-runtime
        passed: [configure-microbosh-vcloud]
      - get: environment
        resource: environment-vcloud
        trigger: true
        passed: [configure-microbosh-vcloud]
      - task: deploy
        tags: [vcloud]
        file: p-runtime/ci/jobs/deploy-microbosh.yml
        config:
          params:
            OPSMAN_VERSION: *om_version
        ensure:
          task: get-install-log
          tags: [vcloud]
          file: p-runtime/ci/jobs/get-install-log.yml
          config:
            params:
              OPSMAN_VERSION: *om_version

  - name: upload-pivotal-vcloud
    plan:
      - aggregate:
        - get: p-runtime
          passed: [deploy-microbosh-vcloud]
        - get: environment
          resource: environment-vcloud
          trigger: true
          passed: [deploy-microbosh-vcloud]
        - get: ert-product
      - task: upload-pivotal
        tags: [vcloud]
        file: p-runtime/ci/jobs/upload-pivotal.yml
        config:
          params:
            OPSMAN_VERSION: *om_version


  - name: configure-ert-vcloud
    plan:
      - get: p-runtime
        passed: [upload-pivotal-vcloud]
      - get: environment
        resource: environment-vcloud
        trigger: true
        passed: [upload-pivotal-vcloud]
      - task: configure-ert
        tags: [vcloud]
        file: p-runtime/ci/jobs/configure-ert.yml
        config:
          params:
            ERT_VERSION: 1.6
            OPSMAN_VERSION: *om_version


  - name: deploy-ert-vcloud
    plan:
      - get: p-runtime
        passed: [configure-ert-vcloud]
      - get: environment
        resource: environment-vcloud
        trigger: true
        passed: [configure-ert-vcloud]
      - task: deploy-ert
        tags: [vcloud]
        file: p-runtime/ci/jobs/deploy-ert.yml
        config:
          params:
            OPSMAN_VERSION: *om_version
        ensure:
          task: get-install-log
          tags: [vcloud]
          file: p-runtime/ci/jobs/get-install-log.yml
          config:
            params:
              OPSMAN_VERSION: *om_version

  - name: run-cats-vcloud
    plan:
      - get: p-runtime
        passed: [deploy-ert-vcloud]
      - get: environment
        resource: environment-vcloud
        trigger: true
        passed: [deploy-ert-vcloud]
      - task: run-cats
        tags: [vcloud]
        file: p-runtime/ci/jobs/run-cats.yml
        config:
          params:
            OPSMAN_VERSION: *om_version

  - name: promote-ops-manager-vcloud
    plan:
      - get: p-runtime
        trigger: true
        passed: [run-cats-vcloud, claim-environment-vcloud]
      - get: latest-opsman-vcloud
        passed: [claim-environment-vcloud]
      - put: stable-opsman-vcloud
        params:
          from: latest-opsman-vcloud/ops_man_image

  - name: destroy-environment-final-vcloud
    plan:
      - get: p-runtime
        passed: [run-cats-vcloud]
      - get: environment
        resource: environment-vcloud
        passed: [run-cats-vcloud]
      - try:
          task: delete-installation
          tags: [vcloud]
          file: p-runtime/ci/jobs/delete-installation.yml
          config:
            params:
              OPSMAN_VERSION: *om_version
      - task: destroy
        tags: [vcloud]
        file: p-runtime/ci/jobs/destroy-environment.yml

  - name: release-environment-vcloud
    plan:
      - get: p-runtime
        passed: [destroy-environment-final-vcloud]
      - get: environment
        resource: environment-vcloud
        trigger: true
        passed: [destroy-environment-final-vcloud]
      - put: environment-vcloud
        params:
          release: environment

groups:
  - name: vsphere-edge
    jobs:
    - claim-environment-vsphere
    - destroy-environment-vsphere
    - deploy-ops-manager-vsphere
    - configure-microbosh-vsphere
    - deploy-microbosh-vsphere
    - upload-pivotal-vsphere
    - configure-ert-vsphere
    - deploy-ert-vsphere
    - run-cats-vsphere
    - promote-ops-manager-vsphere
    - destroy-environment-final-vsphere
    - release-environment-vsphere

  - name: openstack-edge
    jobs:
    - claim-environment-openstack
    - destroy-environment-openstack
    - deploy-ops-manager-openstack
    - configure-microbosh-openstack
    - deploy-microbosh-openstack
    - upload-pivotal-openstack
    - configure-ert-openstack
    - deploy-ert-openstack
    - run-cats-openstack
    - promote-ops-manager-openstack
    - destroy-environment-final-openstack
    - release-environment-openstack

  - name: aws-edge
    jobs:
    - claim-environment-aws
    - destroy-environment-aws
    - deploy-ops-manager-aws
    - configure-microbosh-aws
    - deploy-microbosh-aws
    - upload-pivotal-aws
    - configure-ert-aws
    - deploy-ert-aws
    - run-cats-aws
    - destroy-environment-final-aws
    - promote-ops-manager-aws
    - release-environment-aws

  - name: vcloud-edge
    jobs:
    - claim-environment-vcloud
    - destroy-environment-vcloud
    - deploy-ops-manager-vcloud
    - configure-microbosh-vcloud
    - deploy-microbosh-vcloud
    - upload-pivotal-vcloud
    - configure-ert-vcloud
    - deploy-ert-vcloud
    - run-cats-vcloud
    - destroy-environment-final-vcloud
    - promote-ops-manager-vcloud
    - release-environment-vcloud
