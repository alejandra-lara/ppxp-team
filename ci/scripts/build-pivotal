#!/bin/bash

set -ex

export VERSION=`cat version/number`

if [ "$USE_ERT_DUMMY" == "true" ]; then
  pushd p-runtime
    ./ci/scripts/helpers/bundle-gems.sh

    pushd ert-dummy
      cat ./metadata_parts/binaries.yml
      bundle exec vara build-pivotal --version=$VERSION .
    popd

  popd

  mv p-runtime/ert-dummy/*.pivotal ./ert.pivotal

else

  if [ "$EXTERNAL_RELEASE" != "" ]; then
    external_release_metadata="$PWD/$EXTERNAL_RELEASE"
  fi

  pushd p-runtime
    ./ci/scripts/helpers/bundle-gems.sh

    cat ./metadata_parts/binaries.yml
    bundle exec vara build-pivotal . --version=$VERSION --external-releases=$external_release_metadata

    # concourse streams working directory between containers
    # this won't be needed soon (#94235474, #93927268)
    rm releases/*.tgz
  popd

  mv p-runtime/*.pivotal ./ert.pivotal
fi
