---
property_blueprints:
  - name: networking_poe_ssl_certs
    type: collection
    configurable: true
    property_blueprints:
    - name: name
      type: string
      configurable: true
    - name: certificate
      type: rsa_cert_credentials
      configurable: true
    named_manifests:
    - name: routing_certificates
      manifest: |
        cert_chain: (( current_record.certificate.cert_pem ))
        private_key: (( current_record.certificate.private_key_pem ))

  - name: routing_custom_ca_certificates
    type: text
    configurable: true
    optional: true

  - name: routing_disable_http
    type: boolean
    configurable: true
    default: false

  - name: routing_minimum_tls_version
    type: selector
    configurable: true
    default: tls_v1_2
    option_templates:
      - name: tls_v1_0
        select_value: tls_v1_0
        named_manifests:
          - name: min_tls_version
            manifest: |
              TLSv1.0
          - name: disable_tls_10
            manifest: |
              false
          - name: disable_tls_11
            manifest: |
              false
      - name: tls_v1_1
        select_value: tls_v1_1
        named_manifests:
          - name: min_tls_version
            manifest: |
              TLSv1.1
          - name: disable_tls_10
            manifest: |
              true
          - name: disable_tls_11
            manifest: |
              false
      - name: tls_v1_2
        select_value: tls_v1_2
        named_manifests:
          - name: min_tls_version
            manifest: |
              TLSv1.2
          - name: disable_tls_10
            manifest: |
              true
          - name: disable_tls_11
            manifest: |
              true

  - name: gorouter_ssl_ciphers
    type: text
    configurable: true

  - name: haproxy_ssl_ciphers
    type: text
    configurable: true

  - name: haproxy_max_buffer_size
    type: integer
    configurable: true
    default: 16384

  - name: haproxy_forward_tls
    type: selector
    configurable: true
    default: enable
    option_templates:
    - name: enable
      select_value: enable
      named_manifests:
        - name: backend_port
          manifest: |
            443
        - name: backend_ssl
          manifest: |
            "verify"
      property_blueprints:
      - name: backend_ca
        type: text
        configurable: true
    - name: disable
      select_value: disable
      named_manifests:
        - name: backend_port
          manifest: |
            80
        - name: backend_ssl
          manifest: |
            "off"

  - name: tcp_routing
    type: selector
    configurable: true
    default: disable
    option_templates:
    - name: disable
      select_value: disable
      named_manifests:
        - name: default_router_group
          manifest: |
            []
    - name: enable
      select_value: enable
      named_manifests:
        - name: default_router_group
          manifest: |
            - name: default-tcp
              reservable_ports: (( .properties.tcp_routing.enable.reservable_ports.value ))
              type: tcp
      property_blueprints:
        - name: reservable_ports
          type: string
          configurable: true
          placeholder: "e.g: 1024-10000,65535"

  - name: router_forward_client_cert
    type: selector
    configurable: true
    default: always_forward
    option_templates:
      - name: always_forward
        select_value: always_forward
      - name: forward
        select_value: forward
      - name: sanitize_set
        select_value: sanitize_set

  - name: router_backend_max_conn
    type: integer
    configurable: true
    default: 500

  - name: route_services
    type: selector
    configurable: true
    default: enable
    option_templates:
      - name: enable
        select_value: enable
        named_manifests:
          - name: secret
            manifest: |
              (( .router.route_services_secret.value ))
        property_blueprints:
          - name: ignore_ssl_cert_verification
            type: boolean
            configurable: true
            default: false
      - name: disable
        select_value: disable
        named_manifests:
          - name: secret
            manifest: |

  - name: container_networking_network_cidr
    type: string
    configurable: true
    optional: true

  - name: container_networking_vtep_port
    type: integer
    configurable: true
    default: 4789

  - name: container_networking_log_traffic
    type: selector
    configurable: true
    default: disable
    option_templates:
    - name: enable
      select_value: enable
      named_manifests:
        - name: iptables_logging_enabled
          manifest: |
            true
      property_blueprints:
      - name: iptables_denied_logs_per_sec
        type: integer
        configurable: true
        default: 1
      - name: iptables_accepted_udp_logs_per_sec
        type: integer
        configurable: true
        default: 100

    - name: disable
      select_value: disable
      named_manifests:
        - name: iptables_logging_enabled
          manifest: |
            false

  - name: network_policy_server_cert
    type: rsa_cert_credentials
    default:
      domains:
        - network-policy-server.service.cf.internal
        - "*.network-policy-server.service.cf.internal"

  - name: network_policy_agent_cert
    type: rsa_cert_credentials

  - name: networking_point_of_entry
    type: selector
    configurable: true
    default: haproxy
    option_templates:
    - name: haproxy
      select_value: haproxy
    - name: external_ssl
      select_value: external_ssl

  - name: container_networking
    type: selector
    configurable: true
    default: enable
    option_templates:
    - name: enable
      select_value: enable
    - name: disable
      select_value: disable

  - name: container_networking_interface_plugin
    type: selector
    configurable: true
    default: silk
    option_templates:
    - name: silk
      select_value: silk
      named_manifests:
        - name: runtime_config
          manifest: |
            releases:
            - name: cf-networking
              version: 1.8.1
            addons:
            - name: c2c-diego-cell-cf
              include:
                # this intentionally matches the IST as well as the ERT
                jobs:
                - name: rep
                  release: diego
              jobs:
              - name: cni
                release: cf-networking
                properties:
                  cf_networking:
                    dns_servers: ["169.254.0.2"]
                    mtu: (( .diego_cell.garden_network_mtu.value ))
                    iptables_logging: (( .properties.container_networking_log_traffic.selected_option.parsed_manifest(iptables_logging_enabled) ))
                    iptables_accepted_udp_logs_per_sec: (( .properties.container_networking_log_traffic.enable.iptables_accepted_udp_logs_per_sec.value ))
                    iptables_denied_logs_per_sec: (( .properties.container_networking_log_traffic.enable.iptables_denied_logs_per_sec.value ))
              - name: iptables-logger
                release: cf-networking
              - name: netmon
                release: cf-networking
              - name: silk-daemon
                release: cf-networking
                consumes:
                  cf_network: {from: cf_network, deployment: (( .deployment_name )) }
                properties:
                  cf_networking:
                    silk_daemon:
                      ca_cert: (( $ops_manager.ca_certificate ))
                      client_cert: (( .diego_database.silk_daemon_client_cert.cert_pem ))
                      client_key: (( .diego_database.silk_daemon_client_cert.private_key_pem ))
                    vtep_port: (( .properties.container_networking_vtep_port.value ))
              - name: vxlan-policy-agent
                release: cf-networking
                properties:
                  cf_networking:
                    iptables_logging: (( .properties.container_networking_log_traffic.selected_option.parsed_manifest(iptables_logging_enabled) ))
                    iptables_accepted_udp_logs_per_sec: (( .properties.container_networking_log_traffic.enable.iptables_accepted_udp_logs_per_sec.value ))
                    policy_server:
                      hostname: network-policy-server.service.cf.internal
                    vxlan_policy_agent:
                      client_cert: (( .properties.network_policy_agent_cert.cert_pem ))
                      client_key: (( .properties.network_policy_agent_cert.private_key_pem ))
                      ca_cert: (( $ops_manager.ca_certificate ))
            - name: c2c-diego-database-cf
              include:
                deployments: [(( .deployment_name ))]
                jobs:
                - name: bbs
                  release: diego
              jobs:
              - name: silk-controller
                release: cf-networking
                provides:
                  cf_network: {as: cf_network, shared: true}
                consumes:
                  (( .properties.system_database.selected_option.parsed_manifest(mysql_db_link) ))
                properties:
                  cf_networking:
                    network: (( .properties.container_networking_network_cidr.value || "10.255.0.0/16" ))
                    silk_controller:
                      ca_cert: (( $ops_manager.ca_certificate ))
                      server_cert: (( .diego_database.silk_controller_server_cert.cert_pem ))
                      server_key: (( .diego_database.silk_controller_server_cert.private_key_pem ))
                      database: (( .properties.system_database.selected_option.parsed_manifest(silkdb) ))
        - name: use_container_address
          manifest: |
            false

    - name: external
      select_value: external
      named_manifests:
        - name: runtime_config
          manifest: |
            releases: []
            addons: []
        - name: use_container_address
          manifest: |
            true

  - name: cf_networking_enable_space_developer_self_service
    type: boolean
    configurable: true
    default: false
