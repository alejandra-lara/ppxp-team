---
name: isolated_diego_cell
label: Diego Cell
resource_label: Diego Cell
templates:
  - name: consul_agent
    release: consul
    consumes: |
      consul: nil
      consul_common: {from: consul_common_link, deployment: ((  ..cf.deployment_name  )) }
      consul_client: {from: consul_client_link, deployment: ((  ..cf.deployment_name  )) }
      consul_server: nil
  - name: rep
    release: diego
  - name: route_emitter
    release: diego
    consumes: |
      nats: {from: nats, deployment: ((  ..cf.deployment_name  )) }
  - name: cfdot
    release: diego
  - name: garden
    release: garden-runc
  - name: grootfs
    release: grootfs
  - name: cflinuxfs2-rootfs-setup
    release: cflinuxfs2
  - name: metron_agent
    release: loggregator
  - name: garden-cni
    release: cf-networking
  - name: nfsv3driver
    release: nfs-volume
  - name: syslog_forwarder
    release: syslog-migration

resource_definitions:
  - name: ram
    type: integer
    label: RAM
    configurable: true
    default: 16_384
    constraints:
      min: 2_048

  - name: ephemeral_disk
    type: integer
    label: Ephemeral Disk
    configurable: true
    default: 65_536
    constraints:
      min: 4_096

  - name: persistent_disk
    type: integer
    label: Persistent Disk
    configurable: false
    default: 0

  - name: cpu
    type: integer
    label: CPU
    configurable: true
    default: 2
    constraints:
      min: 1
      power_of_two: true

static_ip: 0
dynamic_ip: 1
max_in_flight: "4%"
single_az_only: false

instance_definition:
  name: instances
  type: integer
  label: Instances
  configurable: true
  default: 3
  constraints:
    min: 0

property_blueprints:
  - name: executor_disk_capacity
    type: integer
    label: Cell Disk Capacity (in MB)
    configurable: true
    optional: true
    constraints:
      min: 1

  - name: executor_memory_capacity
    type: integer
    label: Cell Memory Capacity (in MB)
    configurable: true
    optional: true
    constraints:
      min: 1

  - name: insecure_docker_registry_list
    type: string_list
    configurable: true
    optional: true

  - name: garden_network_mtu
    type: integer
    configurable: true
    optional: false
    default: 1454

  - name: placement_tag
    type: string
    configurable: true

  - name: silk_daemon_client_cert
    type: rsa_cert_credentials
    configurable: false

  - name: network_policy_agent_cert
    type: rsa_cert_credentials

manifest: |
  cflinuxfs2-rootfs:
    trusted_certs: |
      (( $ops_manager.trusted_certificates ))
      ((( /cf/diego-instance-identity-root-ca.certificate )))
  diego:
    executor:
      disk_capacity_mb: (( executor_disk_capacity.value ))
      memory_capacity_mb: (( executor_memory_capacity.value ))
      post_setup_hook: sh -c "rm -f /home/vcap/app/.java-buildpack.log /home/vcap/app/**/.java-buildpack.log"
      post_setup_user: "root"
      ca_certs_for_downloads: (( $ops_manager.ca_certificate ))
      instance_identity_ca_cert: ((( /cf/diego-instance-identity-intermediate-ca.certificate )))
      instance_identity_key: ((( /cf/diego-instance-identity-intermediate-ca.private_key )))
    rep:
      require_tls: true
      ca_cert: (( $ops_manager.ca_certificate ))
      server_cert: (( .properties.rep_server_cert.cert_pem ))
      server_key: (( .properties.rep_server_cert.private_key_pem ))
      use_azure_fault_domains: true
      preloaded_rootfses: '(( .properties.enable_grootfs.value ? .properties.rep_preloaded_rootfses_grootfs.value : .properties.rep_preloaded_rootfses_garden.value ))'
      placement_tags: [ (( placement_tag.value )) ]
      bbs:
        ca_cert: (( $ops_manager.ca_certificate ))
        client_cert: (( .properties.bbs_client_cert.cert_pem ))
        client_key: (( .properties.bbs_client_cert.private_key_pem ))
      locket:
        api_location: locket.service.cf.internal:8891
      trusted_certs: ((( /cf/diego-instance-identity-root-ca.certificate )))
    route_emitter:
      local_mode: true
      bbs:
        ca_cert: (( $ops_manager.ca_certificate ))
        client_cert: (( .properties.bbs_client_cert.cert_pem ))
        client_key: (( .properties.bbs_client_cert.private_key_pem ))
    cfdot:
      bbs:
        ca_cert: (( $ops_manager.ca_certificate ))
        client_cert: (( .properties.bbs_client_cert.cert_pem ))
        client_key: (( .properties.bbs_client_cert.private_key_pem ))
  garden:
    persistent_image_list:
      - "/var/vcap/packages/cflinuxfs2/rootfs"
    graph_cleanup_threshold_in_mb: (( .properties.garden_disk_cleanup.selected_option.parsed_manifest(graph_cleanup_threshold_in_mb) ))
    deny_networks: ["0.0.0.0/0"]
    network_mtu: (( garden_network_mtu.value ))
    insecure_docker_registry_list: (( insecure_docker_registry_list.parsed_strings ))
    http_proxy: (( $ops_manager.http_proxy ))
    https_proxy: (( $ops_manager.https_proxy ))
    no_proxy: (( $ops_manager.no_proxy ))
    network_plugin: "/var/vcap/packages/runc-cni/bin/garden-external-networker"
    network_plugin_extra_args: [ "--configFile=/var/vcap/jobs/garden-cni/config/adapter.json" ]
    image_plugin: '(( .properties.enable_grootfs.value ? .properties.garden_image_plugin.value : .properties.garden_image_plugin_empty.value ))'
    image_plugin_extra_args: '(( .properties.enable_grootfs.value ? .properties.garden_image_plugin_extra_args.value : .properties.garden_image_plugin_empty_args.value ))'
  grootfs:
    graph_cleanup_threshold_in_mb: (( .properties.garden_disk_cleanup.selected_option.parsed_manifest(graph_cleanup_threshold_in_mb) ))
    insecure_docker_registry_list: (( insecure_docker_registry_list.parsed_strings ))
  loggregator:
    use_v2_api: true
    ca_cert: (( $ops_manager.ca_certificate ))
    cert: (( .properties.loggregator_client_cert.cert_pem ))
    key: (( .properties.loggregator_client_cert.private_key_pem ))
    tls:
      ca_cert: (( $ops_manager.ca_certificate ))
      metron:
        cert: (( .properties.metron_tls_cert.cert_pem ))
        key: (( .properties.metron_tls_cert.private_key_pem ))
  nfsv3driver: (( .properties.nfs_volume_driver.selected_option.parsed_manifest(nfsv3driver_properties) ))
  register_direct_instance_routes: (( ..cf.properties.container_networking_interface_plugin.selected_option.parsed_manifest(use_container_address) ))
  syslog: (( .properties.system_logging.selected_option.parsed_manifest(syslog) ))
  tcp:
    enabled: true
  tls:
    ca_cert: (( $ops_manager.ca_certificate ))
    cert: (( .properties.rep_server_cert.cert_pem ))
    key: (( .properties.rep_server_cert.private_key_pem ))
  uaa:
    client_secret: (( ..cf.uaa.tcp_emitter_credentials.password ))
    client_name: (( ..cf.uaa.tcp_emitter_credentials.identity ))
    ca_cert: (( $ops_manager.ca_certificate ))
