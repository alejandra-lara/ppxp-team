---
property_blueprints:
  - name: account_database_name
    type: string
    configurable: false
    default: account

  - name: app_usage_service_database_name
    type: string
    configurable: false
    default: app_usage_service

  - name: autoscale_database_name
    type: string
    configurable: false
    default: autoscale

  - name: ccdb_database_name
    type: string
    configurable: false
    default: ccdb

  - name: diego_database_name
    type: string
    configurable: false
    default: diego

  - name: locket_database_name
    type: string
    configurable: false
    default: locket

  - name: networkpolicyserver_database_name
    type: string
    configurable: false
    default: networkpolicyserver

  - name: notifications_database_name
    type: string
    configurable: false
    default: notifications

  - name: routing_database_name
    type: string
    configurable: false
    default: routing

  - name: silk_database_name
    type: string
    configurable: false
    default: silk

  - name: nfsvolume_database_name
    type: string
    configurable: false
    default: nfsvolume

  - name: magic
    type: selector
    configurable: false
    default: only-option
    option_templates:
      - name: doesnt-matter
        select_value: only-option
        named_manifests:
          - name: proxy
            manifest: |
              "(( .mysql_proxy.service_hostname.value ? .properties.magic.selected_option.parsed_manifest(service_hostname) : .properties.magic.selected_option.parsed_manifest(proxy_link) ))"
          - name: service_hostname
            manifest: |
              database:
                instances:
                - address: (( .mysql_proxy.service_hostname.value ))
          - name: proxy_link
            manifest: |
              database: {from: proxy-mysql}

  - name: more_magic
    type: selector
    configurable: false
    default: only-option
    option_templates:
      - name: doesnt-matter
        select_value: only-option
        named_manifests:
          - name: app_usage_service_proxy
            manifest: |
              "(( .mysql_proxy.service_hostname.value ? .properties.more_magic.selected_option.parsed_manifest(service_hostname) : .properties.more_magic.selected_option.parsed_manifest(proxy_link) ))"
          - name: service_hostname
            manifest: |
              app-usage-database:
                instances:
                - address: (( .mysql_proxy.service_hostname.value ))
          - name: proxy_link
            manifest: |
              app-usage-database: {from: proxy-mysql}

  - name: system_database
    type: selector
    configurable: true
    default: internal_mysql
    option_templates:
      - name: internal
        select_value: internal
        named_manifests:
          - name: mysql_db_link
            manifest: |
              (( .properties.magic.selected_option.parsed_manifest(proxy) ))
          - name: ccdb
            manifest: |
              port: 2544
              db_scheme: "postgres"
              roles:
              - tag: admin
                name: (( .ccdb.credentials.identity ))
                password: (( .ccdb.credentials.password ))
              databases:
              # The tag key is meant to identify the correct db to the cc job, even if an unfamiliar name is used
              - tag: cc
                name: (( .properties.ccdb_database_name.value ))
                citext: true
          - name: ccdb_link
            manifest: |
              database: {from: ccdb}
          - name: notifications
            manifest: |
              port: 3306
              username: (( .mysql.notifications_credentials.identity ))
              password: (( .mysql.notifications_credentials.password ))
              database: (( .properties.notifications_database_name.value ))
              max_open_connections: 10
          - name: autoscaling
            manifest: |
              adapter: "mysql"
              port: 3306
              username: (( .mysql.autoscale_credentials.identity ))
              password: (( .mysql.autoscale_credentials.password ))
              name: (( .properties.autoscale_database_name.value ))
          - name: push-app-usage-service
            manifest: |
              name: (( .properties.app_usage_service_database_name.value ))
              port: 3306
              username: (( .mysql.app_usage_credentials.identity ))
              password: (( .mysql.app_usage_credentials.password ))
          - name: push_app_usage_service_db_link
            manifest: |
              (( .properties.more_magic.selected_option.parsed_manifest(app_usage_service_proxy) ))
          - name: diegodb
            manifest: |
              db_host: mysql.service.cf.internal
              db_port: 3306
              db_schema: (( .properties.diego_database_name.value ))
              db_username: (( .mysql.diegodb_credentials.identity ))
              db_password: (( .mysql.diegodb_credentials.password ))
              max_open_connections: 100
          - name: locketdb
            manifest: |
              db_host: mysql.service.cf.internal
              db_port: 3306
              db_schema: (( .properties.locket_database_name.value ))
              db_username: (( .mysql.locketdb_credentials.identity ))
              db_password: (( .mysql.locketdb_credentials.password ))
          - name: routingdb
            manifest: |
              type: "mysql"
              schema: (( .properties.routing_database_name.value ))
              host: mysql.service.cf.internal
              port: 3306
              username: (( .mysql.routingdb_credentials.identity ))
              password: (( .mysql.routingdb_credentials.password ))
          - name: silkdb
            manifest: |
              type: "mysql"
              name: (( .properties.silk_database_name.value ))
              port: 3306
              username: (( .mysql.silkdb_credentials.identity ))
              password: (( .mysql.silkdb_credentials.password ))
          - name: networkpolicyserverdb
            manifest: |
              type: "mysql"
              name: (( .properties.networkpolicyserver_database_name.value ))
              port: 3306
              username: (( .mysql.networkpolicyserverdb_credentials.identity ))
              password: (( .mysql.networkpolicyserverdb_credentials.password ))
          - name: pivotal_account
            manifest: |
              url: jdbc:mysql://(( .mysql_proxy.service_hostname.value || .mysql_proxy.first_ip )):3306/(( .properties.account_database_name.value ))
              username: (( .mysql.pivotal_account_credentials.identity ))
              password: (( .mysql.pivotal_account_credentials.password ))
          - name: nfsvolume
            manifest: |
              username: (( .mysql.nfsvolume_credentials.identity ))
              password: (( .mysql.nfsvolume_credentials.password ))
              name: (( .properties.nfsvolume_database_name.value ))

      - name: internal_mysql
        select_value: internal_mysql
        named_manifests:
        - name: mysql_db_link
          manifest: |
            (( .properties.magic.selected_option.parsed_manifest(proxy) ))
        - name: ccdb
          manifest: |
            port: 3306
            db_scheme: mysql
            roles:
            - tag: admin
              name: (( .mysql.ccdb_credentials.identity ))
              password: (( .mysql.ccdb_credentials.password ))
            databases:
            - tag: cc
              name: (( .properties.ccdb_database_name.value ))
              citext: true
        - name: ccdb_link
          manifest: |
            (( .properties.magic.selected_option.parsed_manifest(proxy) ))
        - name: notifications
          manifest: |
            port: 3306
            username: (( .mysql.notifications_credentials.identity ))
            password: (( .mysql.notifications_credentials.password ))
            database: (( .properties.notifications_database_name.value ))
            max_open_connections: 10
        - name: autoscaling
          manifest: |
            adapter: "mysql"
            port: 3306
            username: (( .mysql.autoscale_credentials.identity ))
            password: (( .mysql.autoscale_credentials.password ))
            name: (( .properties.autoscale_database_name.value ))
        - name: push-app-usage-service
          manifest: |
            name: (( .properties.app_usage_service_database_name.value ))
            port: 3306
            username: (( .mysql.app_usage_credentials.identity ))
            password: (( .mysql.app_usage_credentials.password ))
        - name: push_app_usage_service_db_link
          manifest: |
            (( .properties.more_magic.selected_option.parsed_manifest(app_usage_service_proxy) ))
        - name: diegodb
          manifest: |
            db_host: mysql.service.cf.internal
            db_port: 3306
            db_schema: (( .properties.diego_database_name.value ))
            db_username: (( .mysql.diegodb_credentials.identity ))
            db_password: (( .mysql.diegodb_credentials.password ))
            max_open_connections: 100
        - name: locketdb
          manifest: |
            db_host: mysql.service.cf.internal
            db_port: 3306
            db_schema: (( .properties.locket_database_name.value ))
            db_username: (( .mysql.locketdb_credentials.identity ))
            db_password: (( .mysql.locketdb_credentials.password ))
        - name: routingdb
          manifest: |
            type: "mysql"
            schema: (( .properties.routing_database_name.value ))
            host: mysql.service.cf.internal
            port: 3306
            username: (( .mysql.routingdb_credentials.identity ))
            password: (( .mysql.routingdb_credentials.password ))
        - name: silkdb
          manifest: |
            type: "mysql"
            name: (( .properties.silk_database_name.value ))
            port: 3306
            username: (( .mysql.silkdb_credentials.identity ))
            password: (( .mysql.silkdb_credentials.password ))
        - name: networkpolicyserverdb
          manifest: |
            type: "mysql"
            name: (( .properties.networkpolicyserver_database_name.value ))
            port: 3306
            username: (( .mysql.networkpolicyserverdb_credentials.identity ))
            password: (( .mysql.networkpolicyserverdb_credentials.password ))
        - name: pivotal_account
          manifest: |
            url: jdbc:mysql://(( .mysql_proxy.service_hostname.value || .mysql_proxy.first_ip )):3306/(( .properties.account_database_name.value ))
            username: (( .mysql.pivotal_account_credentials.identity ))
            password: (( .mysql.pivotal_account_credentials.password ))
        - name: nfsvolume
          manifest: |
            username: (( .mysql.nfsvolume_credentials.identity ))
            password: (( .mysql.nfsvolume_credentials.password ))
            name: (( .properties.nfsvolume_database_name.value ))

      - name: external
        select_value: external
        property_blueprints:
          - name: host
            type: string
            configurable: true
          - name: port
            type: port
            configurable: true
          - name: account_username
            type: string
            configurable: true
          - name: account_password
            type: secret
            configurable: true
          - name: app_usage_service_username
            type: string
            configurable: true
          - name: app_usage_service_password
            type: secret
            configurable: true
          - name: autoscale_username
            type: string
            configurable: true
          - name: autoscale_password
            type: secret
            configurable: true
          - name: ccdb_username
            type: string
            configurable: true
          - name: ccdb_password
            type: secret
            configurable: true
          - name: diego_username
            type: string
            configurable: true
          - name: diego_password
            type: secret
            configurable: true
          - name: locket_username
            type: string
            configurable: true
          - name: locket_password
            type: secret
            configurable: true
          - name: networkpolicyserver_username
            type: string
            configurable: true
          - name: networkpolicyserver_password
            type: secret
            configurable: true
          - name: nfsvolume_username
            type: string
            configurable: true
          - name: nfsvolume_password
            type: secret
            configurable: true
          - name: notifications_username
            type: string
            configurable: true
          - name: notifications_password
            type: secret
            configurable: true
          - name: routing_username
            type: string
            configurable: true
          - name: routing_password
            type: secret
            configurable: true
          - name: silk_username
            type: string
            configurable: true
          - name: silk_password
            type: secret
            configurable: true
        named_manifests:
          - name: mysql_db_link
            manifest: |
              database: nil
          - name: ccdb
            manifest: |
              address: (( .properties.system_database.external.host.value ))
              port: (( .properties.system_database.external.port.value ))
              db_scheme: "mysql"
              roles:
              - tag: admin
                name: (( .properties.system_database.external.ccdb_username.value ))
                password: (( .properties.system_database.external.ccdb_password.value ))
              databases:
              - tag: cc
                name: (( .properties.ccdb_database_name.value ))
          - name: ccdb_link
            manifest: |
              database: nil
          - name: notifications
            manifest: |
              port: (( .properties.system_database.external.port.value ))
              host: (( .properties.system_database.external.host.value ))
              username: (( .properties.system_database.external.notifications_username.value ))
              password: (( .properties.system_database.external.notifications_password.value ))
              database: (( .properties.notifications_database_name.value ))
              max_open_connections: 10
          - name: autoscaling
            manifest: |
              adapter: "mysql"
              port: (( .properties.system_database.external.port.value ))
              username: (( .properties.system_database.external.autoscale_username.value ))
              password: (( .properties.system_database.external.autoscale_password.value ))
              name: (( .properties.autoscale_database_name.value ))
          - name: push-app-usage-service
            manifest: |
              name: (( .properties.app_usage_service_database_name.value ))
              port: (( .properties.system_database.external.port.value ))
              ip: (( .properties.system_database.external.host.value ))
              username: (( .properties.system_database.external.app_usage_service_username.value ))
              password: (( .properties.system_database.external.app_usage_service_password.value ))
          - name: push_app_usage_service_db_link
            manifest: |
              app-usage-database: nil
          - name: diegodb
            manifest: |
              db_host: (( .properties.system_database.external.host.value ))
              db_port: (( .properties.system_database.external.port.value ))
              db_schema: (( .properties.diego_database_name.value ))
              db_username: (( .properties.system_database.external.diego_username.value ))
              db_password: (( .properties.system_database.external.diego_password.value ))
              max_open_connections: 100
          - name: locketdb
            manifest: |
              db_host: (( .properties.system_database.external.host.value ))
              db_port: (( .properties.system_database.external.port.value ))
              db_schema: (( .properties.locket_database_name.value ))
              db_username: (( .properties.system_database.external.locket_username.value ))
              db_password: (( .properties.system_database.external.locket_password.value ))
          - name: routingdb
            manifest: |
              type: "mysql"
              schema: (( .properties.routing_database_name.value ))
              host: (( .properties.system_database.external.host.value ))
              port: (( .properties.system_database.external.port.value ))
              username: (( .properties.system_database.external.routing_username.value ))
              password: (( .properties.system_database.external.routing_password.value ))
          - name: silkdb
            manifest: |
              type: "mysql"
              name: (( .properties.silk_database_name.value ))
              host: (( .properties.system_database.external.host.value ))
              port: (( .properties.system_database.external.port.value ))
              username: (( .properties.system_database.external.silk_username.value ))
              password: (( .properties.system_database.external.silk_password.value ))
          - name: networkpolicyserverdb
            manifest: |
              type: "mysql"
              name: (( .properties.networkpolicyserver_database_name.value ))
              host: (( .properties.system_database.external.host.value ))
              port: (( .properties.system_database.external.port.value ))
              username: (( .properties.system_database.external.networkpolicyserver_username.value ))
              password: (( .properties.system_database.external.networkpolicyserver_password.value ))
          - name: pivotal_account
            manifest: |
              url: jdbc:mysql://(( .properties.system_database.external.host.value )):(( .properties.system_database.external.port.value ))/(( .properties.account_database_name.value ))
              username: (( .properties.system_database.external.account_username.value ))
              password: (( .properties.system_database.external.account_password.value ))
          - name: nfsvolume
            manifest: |
              host: (( .properties.system_database.external.host.value ))
              port: (( .properties.system_database.external.port.value ))
              username: (( .properties.system_database.external.nfsvolume_username.value ))
              password: (( .properties.system_database.external.nfsvolume_password.value ))
              name: (( .properties.nfsvolume_database_name.value ))

  - name: mysql_backups
    type: selector
    configurable: true
    default: disable
    option_templates:
    - name: disable
      select_value: disable
      named_manifests:
      - name: destination
        manifest: |
          - type: s3
            config:
              region:
              endpoint_url:
              bucket_name:
              bucket_path:
              access_key_id:
              secret_access_key:
      - name: cron_schedule
        manifest: |

      - name: backup_all_masters
        manifest: |
          false
    - name: s3
      select_value: s3
      named_manifests:
      - name: destination
        manifest: |
          - type: s3
            config:
              region: (( .properties.mysql_backups.s3.region.value ))
              endpoint_url: (( .properties.mysql_backups.s3.endpoint_url.value ))
              bucket_name: (( .properties.mysql_backups.s3.bucket_name.value ))
              bucket_path: (( .properties.mysql_backups.s3.bucket_path.value ))
              access_key_id: (( .properties.mysql_backups.s3.access_key_id.value ))
              secret_access_key: (( .properties.mysql_backups.s3.secret_access_key.value ))
      - name: cron_schedule
        manifest: |
          (( .properties.mysql_backups.s3.cron_schedule.value ))
      - name: backup_all_masters
        manifest: |
          (( .properties.mysql_backups.s3.backup_all_masters.value ))
      property_blueprints:
      - name: endpoint_url
        type: string
        configurable: true
        default: https://s3.amazonaws.com
      - name: bucket_name
        type: string
        configurable: true
      - name: bucket_path
        type: string
        configurable: true
      - name: access_key_id
        type: string
        configurable: true
      - name: secret_access_key
        type: secret
        configurable: true
      - name: cron_schedule
        type: string
        configurable: true
      - name: backup_all_masters
        type: boolean
        configurable: true
        default: true
      - name: region
        type: dropdown_select
        configurable: true
        optional: true
        default: "us-east-1"
        options:
        - name: "''"
          label: "V2 Signature - N/A"
        - name: "us-east-1"
          label: "US East (N. Virginia)"
        - name: "us-west-1"
          label: "US West (N. California)"
        - name: "us-west-2"
          label: "US West (Oregon)"
        - name: "eu-west-1"
          label: "EU (Ireland)"
        - name: "ap-southeast-1"
          label: "Asia Pacific (Singapore)"
        - name: "ap-northeast-1"
          label: "Asia Pacific (Tokyo)"
        - name: "ap-southeast-2"
          label: "Asia Pacific (Sydney)"
        - name: "sa-east-1"
          label: "South America (São Paulo)"
        - name: "us-gov-west-1"
          label: "V4 Signature Only - GovCloud Region (US)"
        - name: "cn-north-1"
          label: "V4 Signature Only - China Region (Beijing)"
        - name: "eu-central-1"
          label: "V4 Signature Only - EU Region (Frankfurt)"
        - name: "ap-northeast-2"
          label: "V4 Signature Only - Asia Pacific (Seoul)"
    - name: scp
      select_value: scp
      named_manifests:
      - name: destination
        manifest: |
          - type: scp
            config:
              server: ((.properties.mysql_backups.scp.server.value ))
              port: ((.properties.mysql_backups.scp.port.value ))
              user: ((.properties.mysql_backups.scp.user.value ))
              key: ((.properties.mysql_backups.scp.key.value ))
              destination: ((.properties.mysql_backups.scp.destination.value ))
      - name: cron_schedule
        manifest: |
          (( .properties.mysql_backups.scp.cron_schedule.value ))
      - name: backup_all_masters
        manifest: |
          (( .properties.mysql_backups.scp.backup_all_masters.value ))
      property_blueprints:
      - name: server
        type: string
        configurable: true
      - name: port
        type: port
        configurable: true
        default: 22
      - name: user
        type: string
        configurable: true
      - name: key
        type: text
        configurable: true
      - name: destination
        type: string
        configurable: true
      - name: cron_schedule
        type: string
        configurable: true
      - name: backup_all_masters
        type: boolean
        configurable: true
        default: true

  - name: mysql_activity_logging
    type: selector
    configurable: true
    default: enable
    option_templates:
      - name: disable
        select_value: disable
        named_manifests:
          - name: mysql_audit_events
            manifest: ""

      - name: enable
        select_value: enable
        named_manifests:
          - name: mysql_audit_events
            manifest: (( .properties.mysql_activity_logging.enable.audit_logging_events.value ))
        property_blueprints:
          - name: audit_logging_events
            type: string
            configurable: true
            default: "connect,query"
