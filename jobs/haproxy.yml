---
name: haproxy
release: haproxy
manifest: |
  ha_proxy:
    backend_ca_file: (( .properties.haproxy_forward_tls.enable.backend_ca.value ))
    backend_crt: |
      (( .properties.haproxy_client_certificate.cert_pem ))
      (( .properties.haproxy_client_certificate.private_key_pem ))
    backend_port: (( .properties.haproxy_forward_tls.selected_option.parsed_manifest(backend_port) ))
    backend_ssl: (( .properties.haproxy_forward_tls.selected_option.parsed_manifest(backend_ssl) ))
    buffer_size_bytes: (( .properties.haproxy_max_buffer_size.value ))
    client_cert: (( .properties.haproxy_client_cert_validation.selected_option.parsed_manifest(client_cert_validation) ))
    client_timeout: (( .router.request_timeout_in_seconds.value ))
    custom_http_error_files: |
      "503": |
             HTTP/1.1 503 Service Unavailable
             Cache-Control: no-cache
             Connection: close
             Content-Type: text/html

             <html><body><h1>503 Service Unavailable</h1>
             No server is available to handle this request.
             </body></html>

      "504": |
             HTTP/1.1 504 Gateway Time-out
             Cache-Control: no-cache
             Connection: close
             Content-Type: text/html

             <html><body><h1>504 Gateway Time-out</h1>
             The server didn't respond in time.
             </body></html>
    disable_http: (( .properties.routing_disable_http.value ))
    disable_tls_10: (( .properties.routing_minimum_tls_version.selected_option.parsed_manifest(disable_tls_10) ))
    disable_tls_11: (( .properties.routing_minimum_tls_version.selected_option.parsed_manifest(disable_tls_11) ))
    enable_health_check_http: true
    hsts_enable: (( .properties.haproxy_hsts_support.selected_option.parsed_manifest(hsts_enable) ))
    hsts_include_subdomains: (( .properties.haproxy_hsts_support.selected_option.parsed_manifest(hsts_include_subdomains) ))
    hsts_max_age: (( .properties.haproxy_hsts_support.selected_option.parsed_manifest(hsts_max_age) ))
    hsts_preload: (( .properties.haproxy_hsts_support.selected_option.parsed_manifest(hsts_preload) ))
    internal_only_domains: (( .ha_proxy.internal_only_domains.parsed_strings ))
    keepalive_timeout: (( .router.frontend_idle_timeout.value ))
    server_timeout: (( .router.request_timeout_in_seconds.value ))
    ssl_ciphers: (( .properties.haproxy_ssl_ciphers.value ))
    ssl_pem: (( .properties.networking_poe_ssl_certs.parsed_manifest(routing_certificates_and_private_keys) ))
    tcp_link_port: 2222
    trusted_domain_cidrs: (( .ha_proxy.trusted_domain_cidrs.value ))
