---
name: mysql
label: MySQL Server
resource_label: MySQL Server
description: Multi-tenant MySQL server.
templates:
  - name: mysql
    release: cf-mysql
  - name: streaming-mysql-backup-tool
    release: mysql-backup
  - name: send-email
    release: mysql-monitoring

resource_definitions:
- name: ram
  type: integer
  label: RAM
  configurable: true
  default: 8192
  constraints:
    min: 4096
- name: ephemeral_disk
  type: integer
  label: Ephemeral Disk
  configurable: true
  default: 30000
  constraints:
    min: 10000
- name: persistent_disk
  type: integer
  label: Persistent Disk
  configurable: true
  default: 100000
  constraints:
    min: 10000
- name: cpu
  type: integer
  label: CPU
  configurable: true
  default: 2
  constraints:
    min: 1
    power_of_two: true

static_ip: 1
dynamic_ip: 0
max_in_flight: 1
single_az_only: false

instance_definition:
  name: instances
  type: integer
  label: Instances
  configurable: true
  default: 1
  constraints:
    may_only_be_odd_or_zero: true
    min: 0
  zero_if:
    property_reference: .properties.system_database
    property_values:
    - external

property_blueprints:
- name: mysql_admin_credentials
  type: simple_credentials
  default:
    identity: root
- name: mysql_bootstrap_credentials
  type: simple_credentials
  label: Bootstrap Endpoint Credentials
- name: mysql_backup_server_credentials
  type: simple_credentials
  label: Backup Endpoint Credentials
- name: app_usage_credentials
  type: simple_credentials
  default:
    identity: app_usage
- name: notifications_credentials
  type: simple_credentials
- name: autoscale_credentials
  type: simple_credentials
- name: ccdb_credentials
  type: simple_credentials
- name: uaadb_credentials
  type: simple_credentials
- name: consoledb_credentials
  type: simple_credentials
- name: monitordb_credentials
  type: simple_credentials
- name: cluster_health_user
  type: simple_credentials
  default:
    identity: cluster-health-logger
- name: galera_sidecar_user
  type: simple_credentials
  default:
    identity: galera-healthcheck
- name: galera_basic_auth_user
  type: simple_credentials
- name: database_startup_timeout
  type: integer
  configurable: false
  default: 1200

manifest: |
  domain: (( .cloud_controller.system_domain.value ))
  mysql-monitoring:
    recipient_email: (( .mysql_monitor.recipient_email.value ))
    admin_client:
      username: (( .uaa.admin_client_credentials.identity ))
      secret: (( .uaa.admin_client_credentials.password ))
    client:
      username: (( .uaa.notifications_client_credentials.identity ))
      secret: (( .uaa.notifications_client_credentials.password ))
  cf_mysql:
    mysql:
      admin_password: (( mysql_admin_credentials.password ))
      cluster_ips: (( .mysql.ips ))
      database_startup_timeout: (( .mysql.database_startup_timeout.value ))
      innodb_buffer_pool_size: 2147483648
      max_open_files: 1048576
      galera_healthcheck:
        db_password: (( galera_sidecar_user.password ))
        endpoint_username: (( galera_basic_auth_user.password ))
        endpoint_password: (( galera_basic_auth_user.password ))
      cluster_health:
        password: (( cluster_health_user.password ))
      bootstrap_endpoint:
        username: (( mysql_bootstrap_credentials.identity ))
        password: (( mysql_bootstrap_credentials.password ))
      seeded_databases:
        - name: ccdb
          username: (( ccdb_credentials.identity ))
          password: (( ccdb_credentials.password ))
        - name: uaa
          username: (( uaadb_credentials.identity ))
          password: (( uaadb_credentials.password ))
        - name: console
          username: (( consoledb_credentials.identity ))
          password: (( consoledb_credentials.password ))
        - name: app_usage_service
          username: (( app_usage_credentials.identity ))
          password: (( app_usage_credentials.password ))
        - name: notifications
          username: (( notifications_credentials.identity ))
          password: (( notifications_credentials.password ))
        - name: autoscale
          username: (( autoscale_credentials.identity ))
          password: (( autoscale_credentials.password ))
        - name: monitor
          username: (( monitordb_credentials.identity ))
          password: (( monitordb_credentials.password ))
      disable_auto_sst: true
  syslog_aggregator:
    address: (( ..cf.properties.syslog_host.value ))
    port: (( ..cf.properties.syslog_port.value ))
    transport: (( .properties.syslog_protocol.value ))
  cf-mysql-backup:
    endpoint_credentials:
      username: (( mysql_backup_server_credentials.identity ))
      password: (( mysql_backup_server_credentials.password ))
