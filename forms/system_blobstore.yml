---
name: system_blobstore
label: File Storage
description: File Storage
markdown: |
  For help configuring these fields, see the
  [Configure File Storage](https://docs.pivotal.io/pivotalcf/2-10/customizing/configure-pas.html#file-storage)
  section of the _Configuring Application Service_ topic in the product documentation.

verifiers:
  - name: Verifiers::BlobstoreVerifier
    properties:
      endpoint: .properties.system_blobstore.external.endpoint
      access_key_id: .properties.system_blobstore.external.access_key
      secret_access_key: .properties.system_blobstore.external.secret_key
      bucket_name: .properties.system_blobstore.external.buildpacks_bucket
      region: .properties.system_blobstore.external.region
      signature_version: .properties.system_blobstore.external.signature_version

  - name: Verifiers::BlobstoreVerifier
    properties:
      endpoint: .properties.system_blobstore.external.endpoint
      access_key_id: .properties.system_blobstore.external.access_key
      secret_access_key: .properties.system_blobstore.external.secret_key
      bucket_name: .properties.system_blobstore.external.droplets_bucket
      region: .properties.system_blobstore.external.region
      signature_version: .properties.system_blobstore.external.signature_version

  - name: Verifiers::BlobstoreVerifier
    properties:
      endpoint: .properties.system_blobstore.external.endpoint
      access_key_id: .properties.system_blobstore.external.access_key
      secret_access_key: .properties.system_blobstore.external.secret_key
      bucket_name: .properties.system_blobstore.external.packages_bucket
      region: .properties.system_blobstore.external.region
      signature_version: .properties.system_blobstore.external.signature_version

  - name: Verifiers::BlobstoreVerifier
    properties:
      endpoint: .properties.system_blobstore.external.endpoint
      access_key_id: .properties.system_blobstore.external.access_key
      secret_access_key: .properties.system_blobstore.external.secret_key
      bucket_name: .properties.system_blobstore.external.resources_bucket
      region: .properties.system_blobstore.external.region
      signature_version: .properties.system_blobstore.external.signature_version

# go-yaml wraps lines that are longer than 80 characters,
# this breaks templating as $( ) helpers cannot have newlines in the middle.
# The key '_hack' also needs to start with underscore as keys in output are alpha-sorted and
# the variable '$v' must be declared before it is used
# Possible future fix: https://github.com/go-yaml/yaml/issues/387
_hack: '$( $v := regexReplaceAll "^\"?(\\d+)\\.(\\d+).*$" version "${1}-${2}" )'

property_inputs:
- reference: .properties.system_blobstore_ccpackage_max_valid_packages_stored
  label: Maximum valid packages per app
  description: |
    The number of recent, valid packages stored per app,
    not including the package for the current droplet.

- reference: .properties.system_blobstore_ccdroplet_max_staged_droplets_stored
  label: Maximum staged droplets per app
  description: |
    The number of recent, staged droplets stored per app,
    not including the current droplet.

- reference: .properties.system_blobstore_backup_level
  label: Configure file storage backup level
  selector_property_inputs:
  - reference: .properties.system_blobstore_backup_level.all
    label: Complete file storage backup
  - reference: .properties.system_blobstore_backup_level.skip_droplets
    label: Exclude droplets from file storage backup
    description: This option requires restaging Cloud Foundry.
  - reference: .properties.system_blobstore_backup_level.skip_droplets_packages
    label: Exclude droplets and packages from file storage backup
    description: This option requires `cf push`.

- reference: .properties.system_blobstore
  label: "Configure your Cloud Controller's filesystem:"
  selector_property_inputs:
  - reference: .properties.system_blobstore.internal
    label: Internal WebDAV

  - reference: .properties.system_blobstore.external
    label: External S3-compatible filestore
    property_inputs:
      - reference: .properties.system_blobstore.external.endpoint
        label: URL endpoint
        description: The URL endpoint of your S3-compatible filestore.

      - reference: .properties.system_blobstore.external.iam_instance_profile_authentication
        label: S3 AWS with instance profile
        description: The instance profile used for S3 authentication.

      - reference: .properties.system_blobstore.external.access_key
        label: Access key
        description: Required if not using S3 AWS with instance profile.

      - reference: .properties.system_blobstore.external.secret_key
        label: Secret key
        description: Required if not using S3 AWS with instance profile.

      - reference: .properties.system_blobstore.external.signature_version
        label: S3 signature version

      - reference: .properties.system_blobstore.external.region
        label: Region
        description: |
          The AWS region where the buckets are located. For example,
          "us-east-1" or "ap-northeast-1".
        placeholder: "us-east-1"

      - reference: .properties.system_blobstore.external.encryption
        label: Server-side encryption
        description: Available for AWS S3 only.

      - reference: .properties.system_blobstore.external.encryption_kms_key_id
        label: KMS key ID
        description: |
          Encrypts files uploaded to the blobstore using the given KMS key.
          If server-side encryption is enabled and a KMS key ID is not provided,
          the default AWS key is used.

      - reference: .properties.system_blobstore.external.path_style_s3_urls
        label: Path Style S3 URLs (deprecated)
        description: |
          Access S3 buckets using path style syntax instead of domain style syntax.

      - reference: .properties.system_blobstore.external.buildpacks_bucket
        label: Buildpacks bucket name
        description: The S3 bucket for storing app buildpacks.

      - reference: .properties.system_blobstore.external.droplets_bucket
        label: Droplets bucket name
        description: The S3 bucket for storing app droplets.

      - reference: .properties.system_blobstore.external.packages_bucket
        label: Packages bucket name
        description: The S3 bucket for storing app packages.

      - reference: .properties.system_blobstore.external.resources_bucket
        label: Resources bucket name
        description: The S3 bucket for storing app resources.

      - reference: .properties.system_blobstore.external.versioning
        label: Use versioning for backup and restore
        # $v is declared higher up under '_hack'

      - reference: .properties.system_blobstore.external.backup_region
        label: Backup region
        description: |
          The AWS region where the buckets are located. For example,
          "us-east-1" or "ap-northeast-1".
        placeholder: "us-east-1"

      - reference: .properties.system_blobstore.external.buildpacks_backup_bucket
        label: Backup buildpacks bucket name
        description: The S3 bucket used to back up and restore your buildpacks bucket.

      - reference: .properties.system_blobstore.external.droplets_backup_bucket
        label: Backup droplets bucket name
        description: The S3 bucket used to back up and restore your droplets bucket.

      - reference: .properties.system_blobstore.external.packages_backup_bucket
        label: Backup packages bucket name
        description: The S3 bucket used to back up and restore your packages bucket.

  - reference: .properties.system_blobstore.external_gcs
    label: External Google Cloud Storage with access key and secret key
    description:
    property_inputs:
      - reference: .properties.system_blobstore.external_gcs.access_key
        label: Access key

      - reference: .properties.system_blobstore.external_gcs.secret_key
        label: Secret key

      - reference: .properties.system_blobstore.external_gcs.buildpacks_bucket
        label: Buildpacks bucket name
        description: The bucket for storing app buildpacks.

      - reference: .properties.system_blobstore.external_gcs.droplets_bucket
        label: Droplets bucket name
        description: The bucket for storing app droplets.

      - reference: .properties.system_blobstore.external_gcs.packages_bucket
        label: Packages bucket name
        description: The bucket for storing app packages.

      - reference: .properties.system_blobstore.external_gcs.resources_bucket
        label: Resources bucket name
        description: The bucket for storing app resources.

  - reference: .properties.system_blobstore.external_gcs_service_account
    label: External Google Cloud Storage with service account
    description:
    property_inputs:
      - reference: .properties.system_blobstore.external_gcs_service_account.project_id
        label: GCP project ID
        description: Your Google Cloud Platform project ID.

      - reference: .properties.system_blobstore.external_gcs_service_account.service_account_email
        label: GCP service account email
        description: Your Google Cloud Platform service account email.

      - reference: .properties.system_blobstore.external_gcs_service_account.service_account_json_key
        label: GCP service account key JSON
        description: |
          Your Google Cloud Platform service account key with access to the specified
          project and bucket in JSON format.

      - reference: .properties.system_blobstore.external_gcs_service_account.buildpacks_bucket
        label: Buildpacks bucket name
        description: The bucket for storing app buildpacks.

      - reference: .properties.system_blobstore.external_gcs_service_account.droplets_bucket
        label: Droplets bucket name
        description: The bucket for storing app droplets.

      - reference: .properties.system_blobstore.external_gcs_service_account.packages_bucket
        label: Packages bucket name
        description: The bucket for storing app packages.

      - reference: .properties.system_blobstore.external_gcs_service_account.resources_bucket
        label: Resources bucket name
        description: The bucket for storing app resources.

      - reference: .properties.system_blobstore.external_gcs_service_account.backup_bucket
        label: Backup bucket name
        description: The bucket for your buildpack, droplet, and package backup artifacts.

  - reference: .properties.system_blobstore.external_azure
    label: External Azure storage
    description:
    property_inputs:
      - reference: .properties.system_blobstore.external_azure.account_name
        label: Account name

      - reference: .properties.system_blobstore.external_azure.access_key
        label: Access key

      - reference: .properties.system_blobstore.external_azure.environment
        label: Environment
        description: |
          The canonical name for the Azure Cloud environment where
          your storage resides.

      - reference: .properties.system_blobstore.external_azure.buildpacks_container
        label: Buildpacks container name
        description: The container for storing app buildpacks.

      - reference: .properties.system_blobstore.external_azure.droplets_container
        label: Droplets container name
        description: The container for storing app droplets.

      - reference: .properties.system_blobstore.external_azure.packages_container
        label: Packages container name
        description: The container for storing app packages.

      - reference: .properties.system_blobstore.external_azure.resources_container
        label: Resources container name
        description: The container for storing app resources.

      - reference: .properties.system_blobstore.external_azure.enable_bbr
        label: Enable backup and restore

      - reference: .properties.system_blobstore.external_azure.restore_from_account_name
        label: Restore from storage account
        description: |
          Add a separate storage account and access key to restore from files from
          containers in a different storage account.

      - reference: .properties.system_blobstore.external_azure.restore_from_access_key
        label: Restore using access key
        description: |
          Add a separate storage account and access key to restore from files from
          containers in a different storage account.
