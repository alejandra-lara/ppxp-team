---
name: diego_cell
label: Diego Cell
resource_label: Diego Cell
description: Diego Cell
templates:
  - name: consul_agent
    release: consul
  - name: rep
    release: diego
  - name: route_emitter
    release: diego
  - name: cfdot
    release: diego
  - name: garden
    release: garden-runc
  - name: cflinuxfs2-rootfs-setup
    release: cflinuxfs2-rootfs
  - name: metron_agent
    release: loggregator
  - name: cni-flannel
    release: cf-networking
  - name: garden-cni
    release: cf-networking
  - name: netmon
    release: cf-networking
  - name: vxlan-policy-agent
    release: cf-networking
  - name: nfsv3driver
    release: nfs-volume

resource_definitions:
  - name: ram
    type: integer
    label: RAM
    configurable: true
    default: 16_384
    constraints:
      min: 2_048

  - name: ephemeral_disk
    type: integer
    label: Ephemeral Disk
    configurable: true
    default: 65_536
    constraints:
      min: 4_096

  - name: persistent_disk
    type: integer
    label: Persistent Disk
    configurable: false
    default: 0

  - name: cpu
    type: integer
    label: CPU
    configurable: true
    default: 2
    constraints:
      min: 1
      power_of_two: true

static_ip: 0
dynamic_ip: 1
max_in_flight: "10%"
single_az_only: false

instance_definition:
  name: instances
  type: integer
  label: Instances
  configurable: true
  default: 3
  constraints:
    min: 1

property_blueprints:
  - name: executor_disk_capacity
    type: integer
    label: Cell Disk Capacity (in MB)
    configurable: true
    optional: true
    constraints:
      min: 1
  - name: executor_memory_capacity
    type: integer
    label: Cell Memory Capacity (in MB)
    configurable: true
    optional: true
    constraints:
      min: 1
  - name: garden_network_pool
    type: string
    default: 10.254.0.0/22
    configurable: true
    optional: false
  - name: insecure_docker_registry_list
    type: string_list
    configurable: true
    optional: true

  - name: garden_network_mtu
    type: integer
    configurable: true
    optional: false
    default: 1454

  - name: disable_nfsv3driver
    type: boolean
    configurable: true
    default: false

manifest: |
  diego:
    executor:
      disk_capacity_mb: (( executor_disk_capacity.value ))
      memory_capacity_mb: (( executor_memory_capacity.value ))
      post_setup_hook: sh -c "rm -f /home/vcap/app/.java-buildpack.log /home/vcap/app/**/.java-buildpack.log"
      post_setup_user: "root"
      ca_certs_for_downloads: (( $ops_manager.ca_certificate ))
    rep:
      require_tls: true
      enable_legacy_api_endpoints: false
      ca_cert: (( $ops_manager.ca_certificate ))
      server_cert: (( .properties.rep_server_cert.cert_pem ))
      server_key: (( .properties.rep_server_cert.private_key_pem ))
      use_azure_fault_domains: true
      bbs:
        api_location: bbs.service.cf.internal:8889
        ca_cert: (( $ops_manager.ca_certificate ))
        client_cert: (( .properties.bbs_client_cert.cert_pem ))
        client_key: (( .properties.bbs_client_cert.private_key_pem ))
      preloaded_rootfses:
      - cflinuxfs2:/var/vcap/packages/cflinuxfs2/rootfs
    route_emitter:
      local_mode: true
      bbs:
        ca_cert: (( $ops_manager.ca_certificate ))
        client_cert: (( .properties.bbs_client_cert.cert_pem ))
        client_key: (( .properties.bbs_client_cert.private_key_pem ))
      nats:
        user: (( .nats.credentials.identity ))
        password: (( .nats.credentials.password ))
        machines: (( .nats.ips ))
    cfdot:
      bbs:
        ca_cert: (( $ops_manager.ca_certificate ))
        client_cert: (( .properties.bbs_client_cert.cert_pem ))
        client_key: (( .properties.bbs_client_cert.private_key_pem ))
  cflinuxfs2-rootfs:
    trusted_certs: (( $ops_manager.trusted_certificates ))
  consul:
    encrypt_keys:
    - (( .properties.consul_encrypt_key.value ))
    ca_cert: (( $ops_manager.ca_certificate ))
    agent_cert: (( .properties.consul_agent_cert.cert_pem ))
    agent_key: (( .properties.consul_agent_cert.private_key_pem ))
    agent:
      domain: cf.internal
      servers:
        lan: (( .consul_server.ips ))
  syslog_daemon_config:
    address: (( .properties.syslog_host.value ))
    port: (( .properties.syslog_port.value ))
    transport: (( .properties.syslog_protocol.value ))
  metron_agent:
    deployment: cf
  metron_endpoint:
    shared_secret: (( .doppler.shared_secret_credentials.password ))
  loggregator:
    tls:
      ca_cert: (( $ops_manager.ca_certificate ))
      metron:
        cert: (( .doppler.metron_tls_cert.cert_pem ))
        key: (( .doppler.metron_tls_cert.private_key_pem ))
  garden:
    default_container_grace_time: 0
    persistent_image_list:
      - "/var/vcap/packages/cflinuxfs2/rootfs"
    graph_cleanup_threshold_in_mb: (( .properties.garden_disk_cleanup.selected_option.parsed_manifest(graph_cleanup_threshold_in_mb) ))
    network_pool: (( garden_network_pool.value ))
    deny_networks: ["0.0.0.0/0"]
    network_mtu: (( garden_network_mtu.value ))
    insecure_docker_registry_list: (( insecure_docker_registry_list.parsed_strings ))
    http_proxy: (( $ops_manager.http_proxy ))
    https_proxy: (( $ops_manager.https_proxy ))
    no_proxy: (( $ops_manager.no_proxy ))
    network_plugin: (( .properties.container_networking.selected_option.parsed_manifest(garden_network_plugin) ))
    network_plugin_extra_args: (( .properties.container_networking.selected_option.parsed_manifest(garden_network_plugin_extra_args) ))

  cf_networking:
    disable: (( .properties.container_networking.selected_option.parsed_manifest(cf_networking_disabled) ))
    network: (( .properties.container_networking.enable.network_cidr.value ))
    mtu: (( .properties.container_networking.enable.mtu.value ))
    garden_external_networker:
      cni_plugin_dir: /var/vcap/packages/flannel/bin
      cni_config_dir: /var/vcap/jobs/cni-flannel/config/cni
    plugin:
      etcd_endpoints: ['cf-etcd.service.cf.internal']
      etcd_ca_cert: (( $ops_manager.ca_certificate ))
      etcd_client_cert: (( .properties.cf_etcd_client_cert.cert_pem ))
      etcd_client_key: (( .properties.cf_etcd_client_cert.private_key_pem ))
    vxlan_policy_agent:
      policy_server_url: https://network-policy-server.service.cf.internal:4003
      ca_cert: (( $ops_manager.ca_certificate ))
      client_cert: (( .properties.network_policy_agent_cert.cert_pem ))
      client_key: (( .properties.network_policy_agent_cert.private_key_pem ))

  nfsv3driver:
    disable: (( .properties.disable_nfsv3driver.value) ))
